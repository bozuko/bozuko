var auth = require('../auth');
var testsuite = require('./config/testsuite');

var fb_user = {
    id: '32423432523',
    name: 'Charlie Sheen',
    first_name: 'Charlie',
    last_name: 'Sheen',
    email: 'cs@winning.com',
    token: 'dfasaa33345353453543',
    gender: 'male'
};

/**
 *  Mock req and res objects
 */
var req = {
    session: {
        phone: {
            type: 'iphone',
            unique_id: '12412412'
        }
    }
};
var res = {
    send: function() {}
};

exports['Add Facebook user'] = function(test) {
    Bozuko.models.User.addOrModify(fb_user, 'facebook', function(err, u) {
        test.ok(!err);
        test.equal(u.services.length, 1);

        // Add user to the session
        req.session.user = u;

        test.done();
    });
};

exports['authorize user'] = function(test) {
    authorize(test, 'user', true);
};

exports['authorize user - fail'] = function(test) {
    req.session.old_user = req.session.user;
    req.session.user = false;
    authorize(test, 'user', false);
};

exports['authorize mobile'] = function(test) {
    req.session.user = req.session.old_user;
    authorize(test, 'mobile', true);
};

exports['authorize mobile - fail - type mismatch'] = function(test) {
    req.session.phone.type = 'android';
    authorize(test, 'mobile', false);
};


exports.cleanup = function(test) {
    Bozuko.models.User.remove({}, function() {
        test.done();
    });
};

function authorize(test, access, success) {
   // If auth.check fails, the callback will not be called. We should clean up the test.
    var timeout = setTimeout(function() {
        test.ok(!success);
        test.done();
    }, 100);

    var check_user = auth.check(access, function(req, res) {
        clearTimeout(timeout);
        test.ok(success);
        test.done();
    });

    check_user(req, res);
}