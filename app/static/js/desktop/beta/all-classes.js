/*
Copyright(c) 2011 Company Name
*/
Ext.define("Bozuko.lib.Overrides",{constructor:function(){Ext.data.Connection.override({getXhrInstance:(function(){var j=[function(){return new ActiveXObject("MSXML2.XMLHTTP.3.0")},function(){return new XMLHttpRequest()},function(){return new ActiveXObject("MSXML2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],k=0,h=j.length,m;for(;k<h;++k){try{m=j[k];m();break}catch(l){}}return m})()});var d="visibility",b="display",a="hidden",g="none",c=Ext.baseCSSPrefix+"masked",f=Ext.baseCSSPrefix+"masked-relative",e=Ext.core.Element.data;Ext.core.Element.prototype.mask=function(i,n){var p=this,k=p.dom,l=k.style.setExpression,o=Ext.core.DomHelper,m=Ext.baseCSSPrefix+"mask-msg",h,q;if(!(/^body/i.test(k.tagName)&&p.getStyle("position")=="static")){p.addCls(f)}h=e(k,"maskMsg");if(h){h.remove()}h=e(k,"mask");if(h){h.remove()}q=o.append(k,{cls:Ext.baseCSSPrefix+"mask"},true);e(k,"mask",q);p.addCls(c);q.setDisplayed(true);if(typeof i=="string"){var j=o.append(k,{cls:m,cn:{tag:"div"}},true);e(k,"maskMsg",j);j.dom.className=n?m+" "+n:m;j.dom.firstChild.innerHTML=i;j.setDisplayed(true);j.center(p)}if(!Ext.supports.IncludePaddingInWidthCalculation&&Ext.isFunction(l)){q.dom.style.setExpression("width",'this.parentNode.offsetWidth + "px"')}if(!Ext.supports.IncludePaddingInHeightCalculation&&Ext.isFunction(l)){q.dom.style.setExpression("height",'this.parentNode.offsetHeight + "px"')}else{if(Ext.isIE&&!(Ext.isIE7&&Ext.isStrict)&&p.getStyle("height")=="auto"){q.setSize(undefined,p.getHeight())}}return q}}},function(){new Bozuko.lib.Overrides()});Ext.define("Bozuko.lib.app.Controller",{extend:"Ext.app.Controller",createGetters:function(b,a){Ext.Array.each(a,function(e){var d="get",f=e.split("."),c=new RegExp("^Bozuko\\."+b);if(!c.test(e)){return}f.shift();f.shift();Ext.Array.each(f,function(g){d+=Ext.String.capitalize(g)});d+=Ext.String.capitalize(b);if(!this[d]){this[d]=Ext.Function.pass(this["get"+Ext.String.capitalize(b)],[e],this)}},this);this.callParent(arguments)}});Ext.define("Bozuko.view.page.Resources",{extend:"Ext.form.Panel",alias:"widget.pageresources",autoScroll:true,initComponent:function(){var a=this;Ext.apply(a,{bodyPadding:10,layout:"anchor",defaults:{anchor:"0",labelWidth:180},items:[{xtype:"component",autoEl:{tag:"h3",cls:"page-h3"},html:"Resources"},{xtype:"container",items:[{icon:"/images/icons/24/print24.gif",scale:"medium",xtype:"button",text:"Print Your Redemption Instructions",handler:a.printInstructions,scope:a}]},{xtype:"fieldcontainer",fieldLabel:"Your Bozuko Page",layout:"hbox",style:"margin: 10px 0;",items:[{xtype:"component",autoEl:{style:{"line-height":"18px"},tag:"a",href:a.sharePage(),target:"_blank"},html:a.sharePage()}]},{xtype:"fieldset",title:"Website Stamps",autoHeight:true,items:[{xtype:"dataview",ref:"stamp-view",itemSelector:".item",trackOver:true,itemOverCls:"item-over",itemTpl:new Ext.XTemplate('<div class="item" style="clear: both;padding: 10px;">','<img src="{src}" style="float: left; margin-right: 10px;" />','<div style="margin-left: 210px;">',"<div>",'URL: <a href="{src}" target="_blank">',"{src}","</a>","</div>","<div>",'<div style="margin-top: 8px; color: #666;">Code for your site:</div>','<textarea style="font-family: \'courier new\'; color: #666; width: 98%; height: 38px; padding: 4px;" onclick="this.select()">','<a href="{[this.sharePage()]}" target="_blank">','<img src="{src}" alt="Play Bozuko!" />',"</a>","</textarea>","</div>","</div>","</div>",{sharePage:function(){return a.sharePage()}}),store:Ext.create("Ext.data.Store",{autoLoad:true,fields:["src"],data:[{src:"https://s3.amazonaws.com/bozuko/public/stamps/stamp_white.jpg"},{src:"https://s3.amazonaws.com/bozuko/public/stamps/stamp_charcoal.jpg"},{src:"https://s3.amazonaws.com/bozuko/public/stamps/stamp_gray.jpg"}]})}]}]});a.callParent(arguments)},sharePage:function(){return"https://bozuko.com/p/"+this.page.get("_id")},printInstructions:function(){var b=this.page.get("_id"),a=window.open(Bozuko.Router.route("redemption/instructions/"+b),"inst_"+b)}});Ext.define("Bozuko.lib.Router",{extend:"Object",path:Bozuko.routePath||"/admin",constructor:function(){this.callParent(arguments)},setBasePath:function(a){if(!/^\//.test(a)){a="/"+a}this.path=a},route:function(a){if(!/^\//.test(a)){a="/"+a}return this.path+a}},function(){Bozuko.Router=new Bozuko.lib.Router()});Ext.define("Bozuko.lib.data.Model",{extend:"Ext.data.Model",constructor:function(){var a=this;a.addEvents("beforesave","save","beforedelete","delete","modify");a.callParent(arguments)},save:function(a){var b=this;a=Ext.apply({},a);var c=a.success;a.success=function(){if(c){c.call(a.scope||b,arguments)}b.fireEvent("save",b)};if(b.fireEvent("beforesave",b)===false){return}b.callParent([a])},load:function(b){var a=this;if(Ext.type(b)=="function"){b={success:b}}var c=b.success;b.success=function(d){if(d){a.set(d.data)}if(d.associations){d.associations.each(function(f){if(f.type!=="hasMany"){return}var e=a[f.name]();var g=d[f.name]();g.each(function(i){var h;if((h=e.getById(i.getId()))){h.set(i.data);h.commit()}else{e.add(i.data)}});e.each(function(h){if(!g.getById(h.getId())){e.remove(h)}})})}if(c&&Ext.type(c)=="function"){c.apply(b.scope||null,arguments)}};a.self.load(a.getId(),b)},set:function(b){var a=this;a.callParent(arguments);a.fireEvent("modify",a)}});Ext.define("Bozuko.view.page.Account",{extend:"Ext.form.Panel",alias:"widget.pageaccount",autoScroll:true,initComponent:function(){var a=this;Ext.apply(a,{bodyPadding:10,items:[{xtype:"component",autoEl:{tag:"h3",cls:"page-h3"},html:"Account"},{xtype:"component",html:["<p>You are currently enrolled in our invitation only program.</p>","<p>Thank you for participating - we are looking forward to your feedback!</p>"].join("")}]});a.callParent(arguments)}});Ext.define("Bozuko.lib.PubSub",{requires:["Ext.Ajax"],retryAttempts:5,asyncRequests:2,constructor:function(){this.listening=false;this.listeners={};this.canceled=[];this.fails=0;this.failThreshold=3;this.workers=0;this._requestTimeout=0},listen:function(){this.listening=true;this.request()},cancelRequest:function(){clearTimeout(this._requestTimeout);if(this.activeRequest&&this.activeRequest.xhr){this.canceled.push(this.activeRequest.id);this.activeRequest.xhr.abort()}},stopListening:function(){this.listening=false;this.cancelRequest()},request:function(){var c=this;if(!c.listening||(c.activeRequest&&c.activeRequest.xhr)){return}var b=c.getListeners();if(!b||!Ext.Object.getKeys(b).length){return}var a={timeout:60000,url:"/listen",method:"post",callback:c.handleResponse,self:c,jsonData:{listeners:b}};if(c.since){a.jsonData.since=c.since}c.cancelRequest();c.activeRequest=Ext.Ajax.request(a)},getListeners:function(){var b=this,a={};Ext.Object.each(b.listeners,function(d,c){Ext.Object.each(c,function(f,e){if(!a[d]){a[d]=[]}a[d].push(e.conditions)})});return a},subscribe:function(d,b,f){var c=this;if(!c.listeners[d]){c.listeners[d]={}}var a=Ext.encode(b);var e=c.listeners[d];if(e[a]){if(!~Ext.Array.indexOf(e[a].callbacks,f)){e[a].callbacks.push(f)}}else{e[a]={conditions:b,callbacks:[f]}}if(!c.subscribeBuffer){c.subscribeBuffer=Ext.defer(function(){c.listen();c.subscribeBuffer=false},200)}},unsubscribe:function(e,c,g){var d=this;if(!d.listeners[e]){return}var b=Ext.encode(c);var f=d.listeners[e];if(!f[b]||!f[b].callbacks||!f[b].callbacks.length){return}var a=-1;if(~(a=Ext.Array.indexOf(f[b].callbacks,g))){f[b].callbacks.splice(a,1)}if(!f[b].callbacks.length){delete f[b]}if(!Ext.Object.getKeys(f).length){delete d.listeners[e]}},handleResponse:function(b,h,a){var d=b.self,c=[];if(!d.listening){return}if(~Ext.Array.indexOf(d.canceled,a.requestId)){d.canceled.splice(Ext.Array.indexOf(d.canceled,a.requestId),1);return}if(h){try{var f=Ext.decode(a.responseText);Ext.Array.each(f,function(k,j){try{var l=new Date();l.setTime(Date.parse(k.timestamp));k.timestamp=l;c=c.concat(d.onItem(k,j==f.length-1))}catch(m){console.log(m,m.stack)}});d.fails=0}catch(g){console.log(g);d.fails++}}else{d.fails++}if(d.fails>d.failThreshold){var i=Ext.Function.createDelayed(d.request,1000*60,d);i()}else{d.processCallbacks(c,function(){d.request()})}},onItem:function(g,f){var e=this,d=[],c=g.type,b=e.listeners[c],a=e.listeners["*"];if(!b&&!a){return[e.emptyCallback]}Ext.Array.each([b,a],function(h){if(!h){return}Ext.Object.each(h,function(j,k){var m=false;if(k.conditions===true){m=true}else{var i=0,l=0;Ext.Object.each(k.conditions,function(n,o){l++;if(g.message[n]==o){i++}});if(i===l){m=true}}if(m){Ext.Array.each(k.callbacks,function(n){d.push(e.createItemCallback(n,g))})}})});if(f){e.since=g._id}return d},createItemCallback:function(b,c){var a=function(d){b(c,d)};return a},processCallbacks:function(b,e){var d=this,a=false;var c=function(){if(a){return false}if(!b.length&&!d.workers){a=true;return e()}while(b.length&&d.workers<=d.asyncRequests){var f=b.pop();d.workers++;return f(function(){d.workers--;c()})}return true};return c()},emptyCallback:function(a){return a()}},function(){Bozuko.PubSub=new this()});Ext.define("Bozuko.view.chart.Basic",{extend:"Ext.panel.Panel",alias:"widget.bozukochartbasic",requires:["Bozuko.lib.PubSub"],initComponent:function(){var b=this;Ext.define("Ext.chart.theme.Bozuko",{extend:"Ext.chart.theme.Base",constructor:function(c){this.callParent([Ext.apply({colors:["#1db153","#33c667","#4ae07e"]},c)])}});Ext.apply(b,{layout:"anchor",dateFormat:"D M d",items:[{xtype:"panel",border:"false",anchor:"0",layout:"hbox",items:[{xtype:"splitter",width:60},{xtype:"combo",hideLabel:true,forceSelection:true,editable:false,name:"model",queryMode:"local",displayField:"text",value:"Entry",valueField:"value",store:Ext.create("Ext.data.Store",{fields:["text","value"],data:[{text:"Entries",value:"Entry"},{text:"Plays",value:"Play"},{text:"Facebook Wall Posts",value:"Share"},{text:"Total Prize Wins",value:"Prize"},{text:"Redeemed Prizes",value:"Redeemed Prizes"},{text:"Facebook Likes",value:"Likes"},{text:"Check Ins",value:"Checkins"},{text:"Unique Users",value:"Unique Users"},{text:"New Users",value:"New Users"},{text:"Prize Cost",value:"Prize Cost"}]}),listeners:{scope:b,change:b.updateChart}},{xtype:"splitter"},{xtype:"combo",hideLabel:true,forceSelection:true,editable:false,name:"time",queryMode:"local",displayField:"text",value:"week-1",valueField:"value",store:Ext.create("Ext.data.Store",{fields:["text","value"],data:[{text:"Last Minute",value:"minute-1"},{text:"Last 10 Minutes",value:"minute-10"},{text:"Last Day",value:"hour-24"},{text:"Last Two Days",value:"hour-48"},{text:"Last Week",value:"week-1"},{text:"Last Two Weeks",value:"week-2"},{text:"Last Month",value:"week-4"},{text:"Last 6 Months",value:"month-6"},{text:"Last Year",value:"month-12"},{text:"Last 5 Years",value:"year-5"}]}),listeners:{scope:b,change:b.updateChart}},{xtype:"component",flex:1,style:"text-align:right; line-height: 20px; font-size: 16px; font-weight: bold; font-family: Tahoma; padding-right: 10px;",border:false,ref:"chart-total"}]},{xtype:"chart",border:false,theme:"Bozuko",animate:true,height:280,anchor:"0",store:Ext.create("Bozuko.store.Reports"),axes:[{type:"Numeric",position:"left",fields:["count"],title:"Entries",inflections:[],grid:{odd:{opacity:0.5,fill:"#ddd",stroke:"#bbb","stroke-width":1}},label:{renderer:function(d){if(b.modelField.getValue().match(/cost/i)){return Ext.util.Format.usMoney(d)}var c=b.chart.axes.get(0);return c.roundToDecimal(d,c.decimals)}},minimum:0},{type:"Time",position:"bottom",fields:"timestamp",title:"Time",dateFormat:"M d",groupBy:"year,month,day"}],series:[{title:"Count",type:"column",tips:{trackMouse:true,width:150,height:50,renderer:function(e,d){this.setTitle(Ext.Date.format(e.get("timestamp"),b.dateFormat));var c=b.modelField.getValue().match(/cost/i)?Ext.util.Format.usMoney(e.get("count")):e.get("count");this.update(c+" "+b.modelField.getRawValue())}},axis:"left",xField:"timestamp",yField:"count"}],listeners:{scope:b,refresh:b.onChartRefresh}},{xtype:"component",ref:"stats-block",tpl:new Ext.XTemplate('<div class="stats-block">',"<table>","<tr>","<td>","<table>","<thead>",'<tr valign="bottom">','<th colspan="2">Users</th>',"</tr>","</thead>","<tbody>","<tr>","<th>Unique:</th>","<td>{[this.commas(values.users)]}</td>","</tr>","<tr>","<th>Entries:</th>","<td>{[this.commas(values.entries)]}</td>","<tr>","<th>Plays:</th>","<td>{[this.commas(values.plays)]}</td>","</tr>","</tbody>","</table>","</td>","<td>","<table>","<thead>",'<tr valign="bottom">','<th colspan="2">Facebook</th>',"</tr>","</thead>","<tbody>","<tr>","<th>Wall Posts:</th>","<td>{[this.commas(values.wallposts)]}</td>","</tr>","<tr>","<th>Likes:</th>","<td>{[this.commas(values.likes)]}</td>","<tr>","<th>Check Ins:</th>","<td>{[this.commas(values.checkins)]}</td>","</tr>","</tbody>","</table>","</td>",'<td class="last-block">',"<table>","<thead>",'<tr valign="bottom">','<th colspan="2">Prizes</th>',"</tr>","</thead>","<tbody>","<tr>","<th>Won:</th>","<td>{[this.commas(values.wins)]}</td>","</tr>","<tr>","<th>Redeemed:</th>","<td>{[this.commas(values.redeemed)]}</td>","<tr>","<th>Expired:</th>","<td>{[this.commas(values.expired)]}</td>","</tr>","</tbody>","</table>","</td>","</tr>","</table>","</div>",{commas:function(c){return b.addCommas(c)}})}]});b.callParent(arguments);b.chart=b.down("chart");b.chartStore=b.chart.store;b.chartProxy=b.chartStore.getProxy();b.timeField=b.down("[name=time]");b.modelField=b.down("[name=model]");b.updateChart();b.updateStats();var a={};if(b.page_id){a.page_id=b.page_id}Bozuko.PubSub.subscribe("contest/entry",a,b.getCallback("entry"));Bozuko.PubSub.subscribe("contest/play",a,b.getCallback("play"));Bozuko.PubSub.subscribe("contest/win",a,b.getCallback("win"));Bozuko.PubSub.subscribe("prize/redeemed",a,b.getCallback("redeemed"))},resume:function(){this.paused=false;this.updateChart();this.updateStats()},pause:function(){this.paused=true},getCallback:function(b){var c=this,a=function(){return c.modelField.getValue()};callbacks={entry:function(d,e){e();if(!c.isVisible()){return}c.updateStats();if(~Ext.Array.indexOf(["Entry","Share","New Users","Unique Users"],a())){c.loadStore()}},play:function(d,e){e();if(!c.isVisible()){return}c.updateStats();if(~Ext.Array.indexOf(["Play"],a())){c.loadStore()}},win:function(d,e){e();if(!c.isVisible()){return}if(~Ext.Array.indexOf(["Prize"],a())){c.loadStore()}},redeemed:function(d,e){e();if(!c.isVisible()){return}c.updateStats();if(~Ext.Array.indexOf(["Redeemed Prizes","Share","Prize Cost"],a())){c.loadStore()}}};return callbacks[b]},addCommas:function(b){b+="";x=b.split(".");x1=x[0];x2=x.length>1?"."+x[1]:"";var a=/(\d+)(\d{3})/;while(a.test(x1)){x1=x1.replace(a,"$1,$2")}return x1+x2},onChartRefresh:function(){var b=this;var a=String(b.chartStore.sum("count"));if(b.modelField.getValue().match(/cost/i)){a=Ext.util.Format.usMoney(a)}else{a=b.addCommas(a)}b.down("[ref=chart-total]").update(a+' <span style="font-weight: normal;">in this time period</span>')},loadStore:function(){var a=this;if(a.isLoading){a.loadAgain=true;return}a.isLoading=true;if(a.chart&&a.chart.store){a.chart.store.load(function(){a.isLoading=false;if(a.loadAgain){a.loadAgain=false;a.loadStore()}})}},updateStats:function(){var b=this;var a={method:"GET",url:Bozuko.Router.route("/stats"),params:{}};if(b.page_id){a.params.page_id=b.page_id}if(b.contest_id){a.params.contest_id=b.contest_id}a.success=function(d){try{var c=Ext.decode(d.responseText);b.down("[ref=stats-block]").update(c);b.up().doLayout()}catch(f){}};Ext.Ajax.request(a)},updateChart:function(){var a=this;a.chartProxy.extraParams={time:a.timeField.getValue(),model:a.modelField.getValue(),timezoneOffset:(new Date()).getTimezoneOffset()};if(a.page_id){a.chartProxy.extraParams.page_id=a.page_id}if(a.contest_id){a.chartProxy.extraParams.contest_id=a.contest_id}if(a.chart.axes.get(0).setTitle){a.chart.axes.get(0).setTitle(a.modelField.getRawValue());var b=a.timeField.getValue().split("-");b[1]=parseInt(b[1],10);if(/year/i.test(b[0])){if(b[1]>1){a.dateFormat=a.chart.axes.get(1).dateFormat="Y";a.chart.axes.get(1).groupBy="year"}else{a.dateFormat=a.chart.axes.get(1).dateFormat="M Y";a.chart.axes.get(1).groupBy="year,month"}}else{if(/month/i.test(b[0])&&b[1]>1){a.dateFormat=a.chart.axes.get(1).dateFormat="M Y";a.chart.axes.get(1).groupBy="year,month"}else{if(/day/i.test(b[0])){a.dateFormat=a.chart.axes.get(1).dateFormat="ga";a.chart.axes.get(1).groupBy="year,month,day,hour"}else{if(/hour/i.test(b[0])){if(b[1]>1){a.dateFormat=a.chart.axes.get(1).dateFormat="ga";a.chart.axes.get(1).groupBy="year,month,day,hour"}else{a.dateFormat=a.chart.axes.get(1).dateFormat="g:i a";a.chart.axes.get(1).groupBy="year,month,day,hour,minute"}}else{if(/minute/i.test(b[0])){if(b[1]>1){a.dateFormat=a.chart.axes.get(1).dateFormat="g:ia";a.chart.axes.get(1).groupBy="year,month,day,hour,minute"}else{a.dateFormat=a.chart.axes.get(1).dateFormat="g:i:sa";a.chart.axes.get(1).groupBy="year,month,day,hour,minute,second"}}else{a.dateFormat=a.chart.axes.get(1).dateFormat="d M";a.chart.axes.get(1).groupBy="year,month,day"}}}}}}a.chartStore.load()}});Ext.define("Bozuko.view.contest.List",{extend:"Ext.view.View",alias:"widget.contestlist",requires:["Bozuko.lib.PubSub"],emptyText:"No active campaigns.",deferEmptyText:false,initComponent:function(){var a=this;a.callbacks={};Ext.apply(a,{cls:"contest-list",circleRadius:40,trackOver:true,itemSelector:".contest-overview",overItemCls:"contest-overview-over",itemCls:"contest-overview",itemTpl:new Ext.XTemplate('<div class="contest-state contest-state-{state}">','<h3 class="contest-name">{name}</h3>','<div class="contest-info">','<div class="info-row">',"<label>Game:</label>","<span>{game}</span>","</div>",'<div class="info-row">',"<label>Timeline:</label>","<span>{timeline}</span>","</div>",'<div class="info-row">',"<label>Status:</label>","<span>{State}</span>","</div>",'<div class="info-row">',"<label>Prizes:</label>","<span>{prizes}</span>","</div>",'<div class="info-row">',"<label>Entry Type:</label>","<span>{entry_type}</span>","</div>","</div>",'<div class="stat-block stat-block-times">','<div class="circle" style="background-image:url({[this.getCircleUrl(xindex,"times")]})"></div>','<div class="info">',"<h3>Day</h3>",'<div class="stat-info">','<span class="current">{times_current}</span>','<span class="total">of {times_total}</span>',"</div>","</div>","</div>",'<div class="stat-block stat-block-winners">','<div class="circle" style="background-image:url({[this.getCircleUrl(xindex,"winners")]})"></div>','<div class="info">',"<h3>Won Prizes</h3>",'<div class="stat-info">','<span class="current">{winners_current}</span>','<span class="total">of {winners_total}</span>',"</div>","</div>","</div>",'<div class="stat-block stat-block-plays">','<div class="circle" style="background-image:url({[this.getCircleUrl(xindex,"plays")]})"></div>','<div class="info">',"<h3>Plays</h3>",'<div class="stat-info">','<span class="current">{plays_current}</span>','<span class="total">of {plays_total}</span>',"</div>","</div>","</div>",'<div class="stat-block stat-block-entries">','<div class="circle" style="background-image:url({[this.getCircleUrl(xindex,"entries")]})"></div>','<div class="info">',"<h3>Entries</h3>",'<div class="stat-info">','<span class="current">{entries_current}</span>','<span class="total">of {entries_total}</span>',"</div>","</div>","</div>",'<ul class="app-buttons">','<tpl if="this.canReport(values)">','<li><a href="/" onclick="return false;" class="reports">Reports</a></li>',"</tpl>",'<tpl if="this.canEdit(values) && this.isAdmin()">','<li><a href="/" onclick="return false;" class="edit">Edit (Admin)</a></li>',"</tpl>",'<tpl if="this.canEdit(values)">','<li><a href="/" onclick="return false;" class="edit builder">Open</a></li>',"</tpl>",'<tpl if="this.canCopy(values)">','<li><a href="/" onclick="return false;" class="copy">Copy</a></li>',"</tpl>",'<tpl if="this.canPublish(values)">','<li><a href="/" onclick="return false;" class="publish">Publish</a></li>',"</tpl>",'<tpl if="this.canDelete(values)">','<li><a href="/" onclick="return false;" class="delete">Delete</a></li>',"</tpl>",'<tpl if="this.canCancel(values)">','<li><a href="/" onclick="return false;" class="cancel">Cancel</a></li>',"</tpl>",'<tpl if="this.isAdmin()">','<li><a href="/" onclick="return false;" class="export">Export</a></li>',"</tpl>","</ul>","</div>",{getCircleUrl:function(d,c){var b=a.store.getAt(d),e=Math.max(0,Math.min(100,Math.round(a.getData(b)[c+"_percent"]*100)||0));return Bozuko.Router.route("/s3/public/circles/circle-"+e+".png")},isAdmin:function(){return window.location.pathname.match(/^\/admin/)},canEdit:function(b){if(a.actionButtons&&!~Ext.Array.indexOf(a.actionButtons,"edit")){return false}return this.isAdmin()||~Ext.Array.indexOf(["draft","published"],b.state)},canUseBuilder:function(){return window.location.hostname.match(/playground/)},canCopy:function(b){if(a.actionButtons&&!~Ext.Array.indexOf(a.actionButtons,"copy")){return""}return true},canPublish:function(b){if(a.actionButtons&&!~Ext.Array.indexOf(a.actionButtons,"publish")){return""}return ~Ext.Array.indexOf(["draft"],b.state)},canDelete:function(b){if(a.actionButtons&&!~Ext.Array.indexOf(a.actionButtons,"delete")){return""}return ~Ext.Array.indexOf(["draft","published"],b.state)},canCancel:function(b){if(a.actionButtons&&!~Ext.Array.indexOf(a.actionButtons,"cancel")){return""}return ~Ext.Array.indexOf(["active"],b.state)},canReport:function(b){if(a.actionButtons&&!~Ext.Array.indexOf(a.actionButtons,"report")){return""}return ~Ext.Array.indexOf(["active","complete","cancelled"],b.state)}}),listeners:{scope:a,refresh:a.onRefresh,itemupdate:a.onItemUpdate,itemadd:a.onItemUpdate}});a.callParent(arguments);a.on("destroy",a.unPubSub,a)},onRefresh:function(){var a=this;if(!a.rendered){return}a.initPubSub()},onItemUpdate:function(a,b){var c=this;if(!c.rendered){return}if(Ext.isArray(a)){Ext.Array.each(a,function(d){b=c.store.indexOf(d);c.onItemUpdate(d,b)});return}c.initPubSub()},getCallback:function(a){var b=this;if(!b.callbacks[a]){b.callbacks[a]=function(){b[a].apply(b,arguments)}}return b.callbacks[a]},findAndUpdate:function(c,d){var b=this,a=b.store.getById(c.message.contest_id);if(d){d()}if(!a){return}if(b.isLoading){b.loadAgain=true;return}b.isLoading=true;a.load(function(){b.isLoading=false;if(b.loadAgain){b.loadAgain=false;b.findAndUpdate(c)}b.refresh()})},unPubSub:function(){var b=this,a=b.getCallback("findAndUpdate");Ext.each(b._pubsubs,function(c){Bozuko.PubSub.unsubscribe("contest/win",{contest_id:c},a);Bozuko.PubSub.unsubscribe("contest/play",{contest_id:c},a);Bozuko.PubSub.unsubscribe("contest/entry",{contest_id:c},a);Bozuko.PubSub.unsubscribe("prize/redeemed",{contest_id:c},a)})},initPubSub:function(){var b=this,a=b.getCallback("findAndUpdate");b.unPubSub();b._pubsubs=[];b.store.each(function(c){b._pubsubs.push(c.getId());Bozuko.PubSub.subscribe("contest/win",{contest_id:c.get("_id")},a);Bozuko.PubSub.subscribe("contest/play",{contest_id:c.get("_id")},a);Bozuko.PubSub.subscribe("contest/entry",{contest_id:c.get("_id")},a);Bozuko.PubSub.subscribe("prize/redeemed",{contest_id:c.get("_id")},a)})},prepareData:function(c,b,a){return this.getData(a)},getData:function(k){var n=this,j={};if(!k){return j}j.name=k.get("name")||"Untitled";j.game=k.get("game");j.state=k.get("state");j.State=Ext.String.capitalize(k.get("state"));j.game=Ext.String.capitalize(j.game);var m=k.get("game_config");if(m&&m.name){j.game=m.name+" ("+j.game+")"}j.entry_type=k.getEntryType();j.prizes=k.getPrizeCount()+" ("+k.getTotalPrizeCount()+", $"+k.getTotalPrizesValue()+" total retail value)";j.timeline=Ext.Date.format(k.get("start"),"m/d/Y")+" - "+Ext.Date.format(k.get("end"),"m/d/Y");j.entries_current=k.getEntryCount();j.entries_total=k.getTotalEntries();j.entries_percent=j.entries_current/j.entries_total;j.plays_current=k.get("play_cursor")+1;j.plays_total=k.get("total_plays");j.plays_percent=j.plays_current/j.plays_total;j.winners_current=k.getWonPrizeCount();j.winners_total=k.getTotalPrizeCount();j.winners_percent=j.winners_current/j.winners_total;j.redeemed_current=k.getRedeemedPrizeCount();j.redeemed_total=k.getTotalPrizeCount();j.redeemed_percent=j.redeemed_current/j.redeemed_total;var a=new Date(+k.get("start")),h=new Date(+k.get("end")),b=new Date();a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);h.setHours(23);h.setMinutes(59);h.setSeconds(59);h.setMilliseconds(999);var g=+h-a,l=Math.max(0,+b-a),e=1000*60*60,f=e*24,c=Math.ceil(g/f),i=Math.ceil(g/e),o=Math.ceil(l/f),d=Math.ceil(l/e);if(o>c){o=c}if(d>i){d=c}j.times_current=o;j.times_total=c;j.times_percent=l/g;return j}});Ext.define("Bozuko.view.contest.edit.Game",{extend:"Ext.form.Panel",alias:"widget.contestformgame",requires:[],layout:"anchor",defaults:{anchor:"0",labelWidth:150},initComponent:function(){var a=this;a.items=[{xtype:"combo",name:"game",fieldLabel:"Game",forceSelection:true,editable:false,value:"slots",queryMode:"local",store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:"slots",text:"Slots"},{value:"scratch",text:"Scratch"}]}),displayField:"text",valueField:"value",listeners:{scope:a,change:a.onGameChange}},{xtype:"textfield",name:"game_config.name",fieldLabel:"Custom Name (leave blank for default)"},{xtype:"combo",name:"free_play_pct",fieldLabel:"Free Plays",value:"30%",queryMode:"local",editable:false,forceSelection:true,store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:0,text:"None"},{value:10,text:"10%"},{value:20,text:"20%"},{value:30,text:"30%"},{value:40,text:"40%"},{value:50,text:"50%"},{value:60,text:"60%"}]}),displayField:"text",valueField:"value"}];a.callParent();a.on("activate",function(){a.onGameChange(a.down("[name=game]"),a.getForm().getRecord().get("game"))})},onGameChange:function(h,f){var c=this.items.indexOf(this.down("[name=free_play_pct]")),e,d=this;while((e=this.items.getAt(c+1))){this.remove(e)}switch(f){case"slots":this.add({xtype:"combo",name:"game_config.theme",fieldLabel:"Theme",forceSelection:true,editable:false,queryMode:"local",value:"default",store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:"default",text:"Default"},{value:"mexican_theme",text:"Mexican"},{value:"seadog",text:"Seadog"},{value:"alt",text:"Alternate"}]}),displayField:"text",valueField:"value",value:"default"});break;case"scratch":this.add({xtype:"combo",name:"game_config.theme",fieldLabel:"Theme",forceSelection:true,editable:false,queryMode:"local",value:"default",store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:"default",text:"Default"},{value:"rock",text:"Rock"},{value:"custom",text:"Custom"}]}),displayField:"text",valueField:"value",value:"default",listeners:{scope:d,change:function(m,l){var k="custom"===l?"show":"hide";var i=d.down("textfield[name=game_config.custom_background]");var j=d.down("textfield[name=game_config.custom_icon]");Ext.Array.each([i,j],function(n){n[k]();n[k==="show"?"enable":"disable"]()})}}},{xtype:"textfield",name:"game_config.custom_background",fieldLabel:"Custom Background",hidden:true},{xtype:"textfield",name:"game_config.custom_icon",fieldLabel:"Custom Icon",hidden:true});break}var b=this.getForm().getRecord().get("game_config");var a={};for(var g in b){a["game_config."+g]=b[g]}this.getForm().setValues(a)}});Ext.define("Bozuko.view.contest.edit.Entry",{extend:"Ext.form.Panel",alias:"widget.contestformentry",requires:[],layout:"anchor",defaults:{anchor:"0",labelWidth:150},initComponent:function(){var a=this;a.items=[{xtype:"combo",name:"type",fieldLabel:"Method of Entry",emptyText:"Please Select the Entry Type",value:"facebook/checkin",editable:false,forceSelection:true,queryMode:"local",store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:"facebook/checkin",text:"Facebook Check-in"},{value:"facebook/like",text:"Facebook Like"},{value:"bozuko/checkin",text:"Bozuko Check-in"},{value:"bozuko/nothing",text:"Bozuko Play"}]}),displayField:"text",valueField:"value",listeners:{scope:a,change:a.onEntryTypeChange}},{xtype:"checkbox",name:"options.enable_like",fieldLabel:"Additional Like Entry",hidden:true},{xtype:"textfield",name:"tokens",fieldLabel:"Plays per Entry"},{xtype:"textfield",name:"duration",fieldLabel:"Entry Duration (ms)",value:1000*60*60}];a.callParent();a.on("render",function(){var b=a.down("[name=type]");a.onEntryTypeChange(b,b.getValue())})},onEntryTypeChange:function(c,b){var a=b=="facebook/checkin"?"show":"hide";this.down("[name=options.enable_like]")[a]()},setValues:function(a){a["options.enable_like"]=a.options?a.options.enable_like:false;this.getForm().setValues(a)}});Ext.define("Bozuko.view.page.Preview",{extend:"Ext.panel.Panel",alias:"widget.pagepreview",initComponent:function(){var a=this;Ext.apply(a,{width:320,cls:"page-preview",tpl:new Ext.XTemplate(Ext.fly("preview-tmpl").dom.innerHTML)});a.callParent(arguments);a.on("afterrender",a.fixImage,a);a.on("activate",a.fixImage,a)},update:function(){this.callParent(arguments);this.fixImage()},loadRecord:function(a){var b={page:a.data};this.update(b)},fixImage:function(){var c=this;if(!c.getEl()){return}var b=Ext.DomQuery.selectNode(".img img",c.getEl().dom);if(!b){return}var a=function(){b=Ext.fly(b);b.setStyle({"margin-top":(-b.getHeight()/2)+"px","margin-left":(-b.getWidth()/2)+"px"})};if(b.complete){a()}else{b.onload=a}}});Ext.define("Bozuko.view.contest.Overview",{alias:"widget.contestoverview",extend:"Ext.panel.Panel",cls:"contest-overview",requires:["Ext.XTemplate","Bozuko.lib.PubSub"],initComponent:function(){var a=this;a.blocks={};a.circles={};a.callbacks={};Ext.apply(a,{tpl:new Ext.XTemplate('<div class="stat-block stat-block-times">','<div class="circle" style="background-image:url({[this.getCircleUrl("times")]})"></div>','<div class="info">',"<h3>Day</h3>",'<div class="stat-info">','<span class="current">{times_current}</span>','<span class="total">of {times_total}</span>',"</div>","</div>","</div>",'<div class="stat-block stat-block-winners">','<div class="circle" style="background-image:url({[this.getCircleUrl("winners")]})"></div>','<div class="info">',"<h3>Won Prizes</h3>",'<div class="stat-info">','<span class="current">{winners_current}</span>','<span class="total">of {winners_total}</span>',"</div>","</div>","</div>",'<div class="stat-block stat-block-plays">','<div class="circle" style="background-image:url({[this.getCircleUrl("plays")]})"></div>','<div class="info">',"<h3>Plays</h3>",'<div class="stat-info">','<span class="current">{plays_current}</span>','<span class="total">of {plays_total}</span>',"</div>","</div>","</div>",'<div class="stat-block stat-block-entries">','<div class="circle" style="background-image:url({[this.getCircleUrl("entries")]})"></div>','<div class="info">',"<h3>Entries</h3>",'<div class="stat-info">','<span class="current">{entries_current}</span>','<span class="total">of {entries_total}</span>',"</div>","</div>","</div>",'<div class="contest-info">','<div class="info-row">',"<label>Campaign:</label>","<span>{name}</span>","</div>",'<div class="info-row">',"<label>Game:</label>","<span>{game}</span>","</div>",'<div class="info-row">',"<label>Timeline:</label>","<span>{timeline}</span>","</div>",'<div class="info-row">',"<label>Status:</label>","<span>{state}</span>","</div>",'<div class="info-row">',"<label>Entry Type:</label>","<span>{entry_type}</span>","</div>","</div>",{getCircleUrl:function(b){var c=Math.max(0,Math.min(100,Math.round(a.getData()[b+"_percent"]*100)||0));return Bozuko.Router.route("/s3/public/circles/circle-"+c+".png")}}),data:a.getData()});a.callParent(arguments);if(a.record){a.initPubSub()}a.on("destroy",a.unPubSub,a)},getData:function(){var m=this,j={};if(!m.record){return j}j.name=m.record.get("name")||"Untitled";j.game=m.record.get("game");j.state=Ext.String.capitalize(m.record.get("state"));j.game=Ext.String.capitalize(j.game);var l=m.record.get("game_config");if(l&&l.name){j.game=l.name+" ("+j.game+")"}j.entry_type=m.record.getEntryType();j.timeline=Ext.Date.format(m.record.get("start"),"m/d/Y")+" - "+Ext.Date.format(m.record.get("end"),"m/d/Y");j.entries_current=m.record.getEntryCount();j.entries_total=m.record.getTotalEntries();j.entries_percent=j.entries_current/j.entries_total;j.plays_current=m.record.get("play_cursor")+1;j.plays_total=m.record.get("total_plays");j.plays_percent=j.plays_current/j.plays_total;j.winners_current=m.record.getWonPrizeCount();j.winners_total=m.record.getTotalPrizeCount();j.winners_percent=j.winners_current/j.winners_total;j.redeemed_current=m.record.getRedeemedPrizeCount();j.redeemed_total=m.record.getTotalPrizeCount();j.redeemed_percent=j.redeemed_current/j.redeemed_total;var a=new Date(+m.record.get("start")),h=new Date(+m.record.get("end")),b=new Date();a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);h.setHours(23);h.setMinutes(59);h.setSeconds(59);h.setMilliseconds(999);var g=+h-a,k=Math.max(0,+b-a),e=1000*60*60,f=e*24,c=Math.ceil(g/f),i=Math.ceil(g/e),n=Math.ceil(k/f),d=Math.ceil(k/e);if(n>c){n=c}if(d>i){d=c}j.times_current=n;j.times_total=c;j.times_percent=k/g;return j},getCallback:function(a){var b=this;if(!b.callbacks[a]){b.callbacks[a]=function(){b[a].apply(b,arguments)}}return b.callbacks[a]},update:function(a){var b=this;if(a){if(b.record){b.unPubSub()}b.record=a;b.initPubSub()}b.callParent([b.getData()])},unPubSub:function(){var b=this,a=b.getCallback("refresh");Bozuko.PubSub.unsubscribe("contest/win",{contest_id:b.record.get("_id")},a);Bozuko.PubSub.unsubscribe("contest/play",{contest_id:b.record.get("_id")},a);Bozuko.PubSub.unsubscribe("contest/entry",{contest_id:b.record.get("_id")},a);Bozuko.PubSub.unsubscribe("prize/redeemed",{contest_id:b.record.get("_id")},a)},initPubSub:function(){var b=this,a=b.getCallback("refresh");Bozuko.PubSub.subscribe("contest/win",{contest_id:b.record.get("_id")},a);Bozuko.PubSub.subscribe("contest/play",{contest_id:b.record.get("_id")},a);Bozuko.PubSub.subscribe("contest/entry",{contest_id:b.record.get("_id")},a);Bozuko.PubSub.subscribe("prize/redeemed",{contest_id:b.record.get("_id")},a)},refresh:function(b,d){var a=this;if(d){d()}try{if(a.isLoading){a.loadAgain=true;return}a.record.load({scope:a,success:function(){a.update()},callback:function(){a.isLoading=false;if(a.loadAgain){a.loadAgain=false;a.refresh(b)}}})}catch(c){console.log(c)}}});Ext.define("Bozuko.view.contest.Prizes",{extend:"Ext.grid.Panel",alias:"widget.contestprizes",initComponent:function(){var b=this;b.prizes=b.contest.prizes();b.prizes.sort("value","DESC");Ext.apply(b,{autoScroll:true,store:b.prizes,columns:[{header:"Name",dataIndex:"name",flex:1},{header:"Value",dataIndex:"value",width:70,renderer:b.renderers.value},{header:"Total",dataIndex:"total",width:70},{header:"Remaining",dataIndex:"total",width:70,renderer:b.renderers.remaining},{header:"Won",dataIndex:"won",width:70},{header:"Active",dataIndex:"won",width:70,renderer:b.renderers.active},{header:"Expired",dataIndex:"won",width:70,renderer:b.renderers.expired},{header:"Redeemed",dataIndex:"redeemed",width:70}],listeners:{scope:b,itemclick:b.onItemClick}});b.callParent(arguments);var a=Ext.Function.createBuffered(b.updateExpired,2000,b);b.on("render",a);b.prizes.on("update",a);b.on("destroy",function(){b.prizes.un("update",a)})},onItemClick:function(b,a,d,c,e){if(e.getTarget(".download-expired")){window.open(Bozuko.Router.route("/prizes/"+a.get("_id")+"/expired.txt"))}},renderers:{remaining:function(b,c,a){return a.get("total")-a.get("won")},active:function(b,c,a){var d=Ext.isDefined(a.active_count)?a.active_count:"Loading...";return'<div class="'+(a.get("_id")+"-active")+'">'+d+"</div>"},expired:function(b,c,a){var d=Ext.isDefined(a.expired_count)?a.expired_count:"Loading...";return'<div class="'+(a.get("_id")+"-expired")+'">'+d+"</div>"},value:function(a){return"$"+a}},updateExpired:function(){var a=this;Ext.Ajax.request({method:"get",url:Bozuko.Router.route("/prizes/expired"),disableCaching:true,params:{contest_id:a.contest.get("_id")},callback:function(d,e,c){var b=Ext.decode(c.responseText);a.prizes.each(function(k){var l=k.get("_id"),i=k.get("total"),g=b[l],j=k.get("won")-g-k.get("redeemed");k.expired_count=g;k.active_count=j;var h=String(g);var f=k.get("is_barcode")||k.get("is_email");if(g>0&&f){h='<a href="javascript:;" class="download-expired">'+h+"</a>"}a.getEl().down("."+l+"-active").update(String(j));a.getEl().down("."+l+"-expired").update(h)})}})}});Ext.define("Bozuko.view.contest.builder.Preview",{extend:"Ext.panel.Panel",alias:"widget.contestbuilderpreview",initComponent:function(){var a=this;Ext.apply(a,{border:false,tpl:new Ext.XTemplate('<div class="contest-preview">',"<h3>Your Campaign</h3>",'<tpl if="this.noInfo()">',"<p>A campaign preview will update here as you complete each step.</p>","</tpl>",'<tpl if="!this.noInfo()">','<div class="info-row">','<div class="label">Campaign Name</div>','<div class="value campaign-name">{[this.getTitle()]}</div>',"</div>","</tpl>",'<tpl if="!this.noInfo() && this.getTimeline()">','<div class="info-row">','<div class="label">Timeline</div>','<div class="value">{[this.getTimeline()]}</div>',"</div>","</tpl>",'<tpl if="this.getEntryMethod()">','<div class="info-row">','<div class="label">Entry Method</div>','<div class="value">{[this.getEntryMethod()]}</div>',"</div>","</tpl>",'<tpl if="this.getGame()">','<div class="info-row">','<div class="label">Game</div>','<div class="value">{[this.getGame()]}</div>',"</div>","</tpl>",'<tpl if="this.getPrizes()">','<div class="info-row">','<div class="label">Prizes</div>','<div class="value">{[this.getPrizes()]}</div>',"</div>","</tpl>",'<tpl if="this.getOdds()">','<div class="info-row">','<div class="label">Contest Odds</div>','<div class="value">{[this.getOdds()]}</div>',"</div>","</tpl>","</div>",{noInfo:function(){return !a.contest.get("name")},getTitle:function(){return a.contest.get("name")},getTimeline:function(){var c=a.contest.get("start");var b=a.contest.get("end");if(!c||!b){return false}return Ext.Date.format(c,"m/d/Y")+" - "+Ext.Date.format(b,"m/d/Y")},getEntryMethod:function(){var c=a.up("contestbuilder");var d=c.down("[region=center]").items.indexOf(c.down("contestbuilderentry"));if(c.query("[ref=step-btn]")[d].isDisabled()){return""}var b=a.contest.getEntryConfig();if(!b||b.type===""){return false}return a.contest.getEntryType(false)},getGame:function(){var b=a.up("contestbuilder");var c=b.down("[region=center]").items.indexOf(b.down("contestbuildergame"));if(b.query("[ref=step-btn]")[c].isDisabled()){return""}if(!a.contest.get("game")){return false}return a.contest.getGameName()},getPrizes:function(){var b=a.contest.prizes();if(!b.getCount()){return false}return b.getCount()+" Prize Types<br />"+a.contest.getTotalPrizeCount()+" Total Prizes<br />$"+a.contest.getTotalPrizesValue()+" Total Value"},getOdds:function(){var b=a.up("contestbuilder");var c=b.down("[region=center]").items.indexOf(b.down("contestbuilderodds"));if(b.query("[ref=step-btn]")[c].isDisabled()){return""}return["1 in "+a.contest.get("win_frequency").toFixed(1)+" entries will win","<br />",a.contest.get("total_entries")+" Total Entries"].join("")}})});a.callParent(arguments);a.contest.on("modify",a.onContestModify,a);a.contest.prizes().on("update",a.onContestModify,a);a.on("destroy",function(){a.contest.un("modify",a.onContestModify,a);a.contest.prizes().un("update",a.onContestModify,a)});a.on("render",a.update,a)},onContestModify:function(){var a=this;a.update(a.contest.raw)}});Ext.define("Bozuko.view.contest.edit.Rules",{extend:"Ext.form.Panel",alias:"widget.contestformrules",requires:[],layout:"anchor",autoScroll:true,defaults:{anchor:"0",labelWidth:150},initComponent:function(){var a=this;a.items=[{xtype:"checkbox",name:"auto_rules",fieldLabel:"Auto Generate Rules",listeners:{scope:a,change:a.onAutoChange}},{xtype:"textarea",height:300,labelAlign:"top",name:"rules",fieldLabel:"Rules"}];a.callParent()},onAutoChange:function(b,c){var a=c?"disable":"enable";this.down("[name=rules]")[a]()}});Ext.define("Bozuko.view.contest.edit.Prize",{extend:"Ext.form.Panel",alias:"widget.contestformprize",requires:[],border:false,autoHeight:true,initComponent:function(){var a=this;a.items=[{xtype:"fieldset",title:"Prize",layout:"anchor",style:"background-color: #f3f3f3",defaults:{xtype:"textfield",anchor:"0",labelWidth:150},items:[{name:"name",fieldLabel:"Name",allowBlank:false},{name:"total",fieldLabel:"Total",allowBlank:false},{name:"value",fieldLabel:"Value",allowBlank:false},{xtype:"textarea",height:60,name:"description",fieldLabel:"Description",allowBlank:false},{name:"instructions",fieldLabel:"Instructions",allowBlank:false},{name:"duration",fieldLabel:"Redemption Period",allowBlank:false,value:1000*60*2},{xtype:"checkbox",name:"is_barcode",fieldLabel:"Use Barcodes",allowBlank:false,listeners:{scope:a,change:a.onBarcodeChange}},{xtype:"textarea",height:80,hidden:true,name:"barcodes",fieldLabel:"Barcodes (one per line)",allowBlank:false,getValue:function(){var b=Ext.form.field.TextArea.prototype.getRawValue.apply(this);return b.split("\n")},setValue:function(b){if(Ext.isString(b)){b=b.split("\n")}Ext.form.field.TextArea.prototype.setValue.apply(this,[(b||[]).join("\n")])}},{xtype:"checkbox",name:"is_email",fieldLabel:"Email Prize?",allowBlank:false,listeners:{scope:a,change:a.onEmailChange}},{xtype:"textarea",height:100,hidden:true,name:"email_body",fieldLabel:"Email Body",allowBlank:false},{xtype:"textarea",height:80,hidden:true,name:"email_codes",fieldLabel:"Email Codes (one per line)",allowBlank:false,getValue:function(){var c=Ext.form.field.TextArea.prototype.getRawValue.apply(this);var b=c.split("\n");if(b.length){if(b[0]===""){b.shift()}if(b.length){if(b[b.length]===""){b.pop()}}}return b},setValue:function(b){if(Ext.isString(b)){b=b.split("\n")}Ext.form.field.TextArea.prototype.setValue.apply(this,[(b||[]).join("\n")])}},{xtype:"container",border:false,style:"text-align:right",html:['<a class="remove-prize" href="javascript:;" style="color: red; font-weight: bold;">Remove Prize</a>'].join(""),listeners:{afterrender:function(){this.el.down("a").on("click",function(){a.fireEvent("removeprize",a.record,a)})}}}]}];a.callParent();if(a.record){a.loadRecord(record)}},onEmailChange:function(c,b){var a=b?"show":"hide";Ext.Array.each(this.query("[name=email_body], [name=email_codes]"),function(d){d[a]()})},onBarcodeChange:function(c,b){var a=b?"show":"hide";Ext.Array.each(this.query("[name=barcodes]"),function(d){d[a]()})},getValues:function(a){var c=this;var b={};a=a?a+" field":"field";Ext.Array.each(c.query(a),function(f){var d=f.getName().split("."),g=b;if(d.length>1){while(d.length>1){var e=d.shift();if(!g[e]){g[e]={}}g=g[e]}}g[d.shift()]=f.getValue()});return b},updateRecord:function(){var a=this.getValues();this.record.set(a)}});Ext.define("Bozuko.model.Prize",{extend:"Bozuko.lib.data.Model",idProperty:"_id",fields:[{name:"_id",type:"String"},{name:"value",type:"Number"},{name:"duration",type:"Number",defaultValue:1000*60*60*24*7},{name:"image",type:"String"},{name:"name",type:"String"},{name:"description",type:"String"},{name:"details",type:"String"},{name:"redemption_type",type:"String"},{name:"instructions",type:"String"},{name:"image",type:"String"},{name:"total",type:"Number"},{name:"won",type:"Number"},{name:"redeemed",type:"Number"},{name:"is_email",type:"Boolean"},{name:"is_barcode",type:"Boolean"},{name:"barcodes",type:"Array"},{name:"barcode_type",type:"String",defaultValue:"39"},{name:"email_format",type:"String",defaultValue:"text/plain"},{name:"email_subject",type:"String"},{name:"email_body",type:"String"},{name:"email_codes",type:"Array"}],associations:{type:"belongsTo",model:"Bozuko.lib.data.Contest"},getDefaultInstructions:function(b){var d=this,a="",c=d.get("redemption_type")||b;if(d.store){d.store.each(function(e){if(e!==d&&e.get("redemption_type")==c&&e.get("instructions")!=""){a=e.get("instructions");return false}return true})}if(a!==""){return a}switch(c){case"email":a='Press "Redeem" and your prize will be emailed to you.';break;case"barcode":case"image":a='Please show this screen to an employee before pressing "Redeem".';break}return a},getDefaultEmailSubject:function(){return this.get("email_subject")||"Congratulations! you won a {prize}"},getDefaultEmailBody:function(){return this.get("email_body")||["<p>Hi {name}</p>","<p>Congratulations! You have won a {prize}. Here is your gift code:</p>","<p>{code}</p>"].join("")}});Ext.define("Bozuko.view.contest.builder.Card",{alias:"widget.contestbuildercard",extend:"Ext.panel.Panel",layout:"border",cls:"builder-card",border:false,helpRegion:"west",helpRegionWidth:200,autoScroll:true,name:"Builder Card",overview:"Card Overview",constructor:function(){this.form={region:"center",border:false,autoScroll:true,xtype:"form",ref:"card-form",layout:"anchor",cls:"builder-card",bodyCls:"builder-card-body",defaults:{xtype:"textfield",labelWidth:120,anchor:"0"},dockedItems:[{ref:"nav-bar",dock:"bottom",xtype:"toolbar",cls:"x-toolbar card-nav-toolbar",defaults:{scale:"medium"}}]};this.callParent(arguments)},initComponent:function(){var b=this;Ext.apply(b,{defaults:{border:false},items:[b.form,{xtype:"panel",ref:"help-panel",region:b.helpRegion,width:b.helpRegionWidth,cls:"help-panel"}]});b.callParent(arguments);b.on("activate",b.focusFirstField,b);b.form=b.down("[ref=card-form]");var a=b.query("[ref=card-form] field");Ext.Array.each(a,function(c){c.on("focus",function(d){b.onFieldFocus(d)});c.on("blur",function(d){b.onFieldBlur(d)});c.on({scope:b,blur:b.updateRecord,select:b.updateRecord})});Ext.Array.each(b.query("[ref=card-form] htmleditor"),function(c){c.on("activate",function(d){b.onFieldFocus(d);Ext.EventManager.on(d.getWin(),"focus",function(){b.onFieldFocus(d)})});c.on({scope:b,change:b.updateRecord})});if(b.intro){b.form.insert(0,{xtype:"component",autoEl:{tag:"div",cls:"intro"},html:(Ext.isArray(b.intro)?b.intro.join(""):b.intro)})}b.loadContest()},focusFirstField:function(){var b=this;var a=b.form.getEl().down("input,select,textarea");if(a){a.focus()}},updateRecord:function(){var a=this;a.contest.set(a.getValues())},loadContest:function(){var a=this;a.form.loadRecord(a.contest)},getValues:function(){var b=this,a={};Ext.each(b.form.query("field"),function(e){var d=e.name.split("."),f=a;while(d.length>1){var c=d.shift();if(!f[c]){f[c]={}}f=f[c]}f[d.shift()]=e.getValue()});return a},validate:function(){return this.form.getForm().isValid()},onRender:function(){var a=this;a.callParent(arguments);a.helpPanel=a.down("[ref=help-panel]");a.arrow=document.createElement("div");a.arrow.className="builder-arrow";setTimeout(function(){a.updateHelpText(a.overview)},100)},onFieldFocus:function(b){var a=this;if(b.up("duration")){b=b.up("duration")}if(b.up("fieldcontainer")){b=b.up("fieldcontainer")}setTimeout(function(){a.blurred=false;if(b.up("[arrowCt=true]")){b.up("[arrowCt=true]").getEl().dom.appendChild(a.arrow)}else{b.getEl().dom.appendChild(a.arrow)}var d=b.helpText||"",c=b.helpLabel||b.fieldLabel;if(Ext.isArray(d)){d=d.join("")}d="<h3>"+c+"</h3>"+d;a.updateHelpText(d)},10)},onFieldBlur:function(b){var a=this;a.blurred=true;setTimeout(function(){if(!a.blurred){return}try{a.arrow.parentNode.removeChild(a.arrow)}catch(c){}a.updateHelpText(a.getOverview())},500)},getOverview:function(){return this.overview},updateHelpText:function(a){var b=this;if(Ext.isArray(a)){a=a.join("")}try{b.helpPanel.update('<div class="help-text">'+a+"</div>")}catch(c){}},addNavigationButtons:function(c){var b=this;var a=[];if(~Ext.Array.indexOf(c,"back")){a.push({text:"Back",handler:function(){b.fireEvent("back",b)},icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/arrow-left-24.png"})}a.push("->");if(~Ext.Array.indexOf(c,"next")){a.push({text:"Next",style:"margin-right: 0",handler:function(){b.fireEvent("next",b)},icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/arrow-right-24.png"})}if(~Ext.Array.indexOf(c,"apply")){a.push({text:"Save",ref:"apply",style:"margin-right: 0",handler:function(){b.fireEvent("apply",b)},icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/check-24.png"})}if(~Ext.Array.indexOf(c,"save")){a.push({text:"Save and Close",ref:"save",style:"margin-right: 0",handler:function(){b.fireEvent("save",b)},icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-circle-check-24.png"})}if(~Ext.Array.indexOf(c,"save-draft")){a.push({text:"Save as Draft",ref:"save",style:"margin-right: 0",handler:function(){b.fireEvent("save",b)},icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-circle-check-24.png"})}if(~Ext.Array.indexOf(c,"publish")){a.push({text:"Publish",style:"margin-right: 0",handler:function(){b.fireEvent("publish",b)},icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-circle-direction-right-24.png"})}a.unshift(" ");a.push(" ");b.down("[ref=nav-bar]").add(a)}});Ext.define("Bozuko.lib.form.field.Duration",{extend:"Ext.form.FieldContainer",alias:"widget.duration",mixins:{field:"Ext.form.field.Field"},cls:"duration-field",fieldLabel:"Duration",durations:[{label:"Years",value:1000*60*60*24*365},{label:"Months",value:1000*60*60*24*30},{label:"Weeks",value:1000*60*60*24*7},{label:"Days",value:1000*60*60*24},{label:"Hours",value:1000*60*60},{label:"Minutes",value:1000*60},{label:"Seconds",value:1000}],initComponent:function(){var a=this;Ext.apply(a,{layout:"hbox",items:[{width:40,xtype:"textfield",ref:"value",allowBlank:false,regexMask:/[0-9\.]/},{xtype:"splitter"},{width:80,ref:"unit",xtype:"combo",queryMode:"local",editable:false,forceSelection:true,displayField:"label",valueField:"value",value:this.durations[3].value,store:Ext.create("Ext.data.Store",{fields:["label","value"],data:a.durations})}]});a.callParent(arguments);a.valueField=a.down("[ref=value]");a.unitField=a.down("[ref=unit]");a.initField()},focus:function(){this.valueField.focus()},isValid:function(){return this.valueField.isValid()},setValue:function(a){var f=this,c="m",h=0;this.value=a;if(Ext.isString(a)){a=parseInt(a,10)}for(var e=0;e<this.durations.length;e++){if(a>=this.durations[e].value){var g=this.durations[e].value;h=a/g,c=g;if(Math.round(h)!=h&&!this.isTwoDecimalPlacesOrLess(h)){for(var b=e;b<this.durations.length;b++){g=this.durations[b].value;var k=a/g;if(Math.round(k)==k||this.isTwoDecimalPlacesOrLess(k)){h=k,c=g;break}}}break}}if(h==0){return}f.unitField.setValue(c);f.valueField.setValue(h)},isTwoDecimalPlacesOrLess:function(b){var a=new String(b);if(!~a.indexOf(".")){return true}return a.split(".")[1].length<3},getValue:function(){var b=this;var c=Number(b.valueField.getValue()),a=Number(b.unitField.getValue());return c*a}});Ext.define("Bozuko.store.EntryTypes",{extend:"Ext.data.Store",fields:["img","title","description","type","options"],data:[{type:"facebook/checkin",title:"Facebook Check in",img:"/images/desktop/app/builder/entry/facebook-checkin-fit.png",description:['<p>A player must be present at your location and all entries post to player\'s walls.  Using the Bozuko app, players can "check in and play" with a single button.</p>'].join("")},{type:"facebook/like",title:"Facebook Like",img:"/images/desktop/app/builder/entry/facebook-like-fit.png",description:['<p>A player must first Facebook "Like" your business on in order to play the game.  The Bozuko application makes Liking your business easy by presenting the user an integrated Like button on your game page.</p>'].join("")},{type:"bozuko/checkin",title:"Bozuko Check in",img:"/images/desktop/app/builder/entry/bozuko-checkin-fit.png",description:["<p>A user must be at your location to play the game.</p>"].join("")},{type:"bozuko/nothing",title:"No Requirement",img:"/images/desktop/app/builder/entry/bozuko-play-fit.png",description:["<p>There is no requirement on players outside of play frequency.</p>"].join("")}]},function(){Ext.create("Bozuko.store.EntryTypes",{storeId:"entry-types"})});Ext.define("Bozuko.model.User",{extend:"Ext.data.Model",idProperty:"_id",proxy:{type:"rest",url:"/users",reader:{type:"json",root:"items",totalProperty:"total"}},fields:[{name:"_id",type:"String"},{name:"name",type:"String"},{name:"email",type:"String"},{name:"image",type:"String"},{name:"entry_id",type:"String"},{name:"blocked",type:"Boolean",defaultValue:false},{name:"allowed",type:"Boolean",defaultValue:false},{name:"services",type:"Array"}],service:function(a){var d=this,c=this.get("services");for(var b=0;b<c.length;b++){if(c[b].name==a){return c[b]}}return false}},function(){this.prototype.proxy.url=Bozuko.Router.route(this.prototype.proxy.url)});Ext.define("Bozuko.lib.form.field.WinFrequency",{extend:"Ext.form.FieldContainer",alias:"widget.winfrequencyfield",mixins:{field:"Ext.form.field.Field"},cls:"overallodds-field",fieldLabel:"Overall Odds",initComponent:function(){var a=this;Ext.apply(a,{layout:"hbox",layoutConfig:{pack:"center",align:"middle"},height:22,items:[{xtype:"component",autoEl:{tag:"div"},html:"One in every",flex:1,style:"height: auto; line-height: 18px; text-align:right;"},{xtype:"splitter"},{xtype:"textfield",style:"text-align:center;",ref:"value",width:40},{xtype:"splitter"},{xtype:"component",autoEl:{tag:"div",style:"height: auto;  line-height: 18px;"},flex:1,html:"entries win."}]});a.addEvents("change","keyup");a.callParent(arguments);a.valueField=a.down("[ref=value]");a.relayEvents(a.valueField,["change","keyup"]);a.initField()},focus:function(){var a=this;a.valueField.focus()},setValue:function(a){var b=this;b.valueField.setValue(a)},getValue:function(){var a=this;return Number(a.valueField.getValue())}});Ext.define("Ext.ux.picker.DateTime",{extend:"Ext.picker.Date",requires:["Ext.form.field.Time"],alias:"widget.datetimepicker",alternateClassName:"Ext.DateTimePicker",renderTpl:['<div class="{cls} x-datetime-picker" id="{id}" role="grid" title="{ariaTitle} {value:this.longDay}">','<div role="presentation" class="{baseCls}-header">','<div class="{baseCls}-prev"><a href="#" role="button" title="{prevText}"></a></div>','<div class="{baseCls}-month"></div>','<div class="{baseCls}-next"><a href="#" role="button" title="{nextText}"></a></div>',"</div>",'<table class="{baseCls}-inner" cellspacing="0" role="presentation">','<thead role="presentation"><tr role="presentation">','<tpl for="dayNames">','<th role="columnheader" title="{.}"><span>{.:this.firstInitial}</span></th>',"</tpl>","</tr></thead>",'<tbody role="presentation"><tr role="presentation">','<tpl for="days">',"{#:this.isEndOfWeek}",'<td role="gridcell" id="{[Ext.id()]}">','<a role="presentation" href="#" hidefocus="on" class="{parent.baseCls}-date" tabIndex="1">','<em role="presentation"><span role="presentation"></span></em>',"</a>","</td>","</tpl>","</tr></tbody>","</table>",'<tpl if="showToday || showTime">','<div role="presentation" class="{baseCls}-footer"></div>',"</tpl>","</div>",{firstInitial:function(a){return a.substr(0,1)},isEndOfWeek:function(b){b--;var a=b%7===0&&b!==0;return a?'</tr><tr role="row">':""},longDay:function(a){return Ext.Date.format(a,this.longDayFormat)}}],initComponent:function(){var a=this;a.addEvents({timechange:true});a.on("select",a._onSelect,a);a.callParent(arguments)},showTime:true,onRender:function(){var a=this;Ext.apply(a.renderData,{showTime:a.showTime});a.callParent(arguments);a.hourField=Ext.create("Ext.form.field.Spinner",{renderTo:a.footerEl,width:40,value:"12",hideLabel:true,listeners:{scope:a,spin:a.onHourSpin}});a.minuteField=Ext.create("Ext.form.field.Spinner",{renderTo:a.footerEl,width:40,value:"00",hideLabel:true,listeners:{scope:a,spin:a.onMinuteSpin}});a.ampmField=Ext.create("Ext.form.field.Spinner",{renderTo:a.footerEl,width:42,value:"PM",hideLabel:true,listeners:{scope:a,spin:a.onAmPmSpin}})},onHourSpin:function(b,a){this.spin(b,a,1,12,1);this.setTimeValue();this.fireEvent("timechange",this.value)},onMinuteSpin:function(b,a){this.spin(b,a,0,55,5);this.setTimeValue();this.fireEvent("timechange",this.value)},spin:function(g,f,d,a,e){var c=f=="up",b=parseInt(g.getValue(),10);b+=((c?1:-1)*e);if(b<d){b=a}else{if(b>a){b=d}}g.setValue(Ext.String.leftPad(b,2,"0"))},onAmPmSpin:function(b,a){b.setValue(b.getValue()=="AM"?"PM":"AM");this.setTimeValue();this.fireEvent("timechange",this.value)},_onSelect:function(c,a){var b=this;b.setTimeValue()},setTimeValue:function(){var e=this;var d=parseInt(e.hourField.getValue(),10);var b=parseInt(e.minuteField.getValue(),10);var c=e.ampmField.getValue()=="AM";if(d!=12&&!c){d+=12}else{if(d==12&&c){d=24}}e.value.setHours(d==24?0:d);e.value.setMinutes(b)}});Ext.define("Ext.ux.data.writer.JsonDeep",{extend:"Ext.data.writer.Json",alias:"writer.jsondeep",getRecordData:function(a){var b=this,c=b.callParent(arguments);a.associations.each(function(d){if(d.type!="hasMany"){return}var e=d.associationKey;c[e]=[];if(!a[d.storeName]){return}a[d.storeName].each(function(f){c[e].push(b.getRecordData.call(b,f))})});return c}});Ext.define("Bozuko.model.Entry",{extend:"Ext.data.Model",idProperty:"_id",requires:["Bozuko.lib.Router"],proxy:{type:"rest",url:"/entries",reader:{type:"json",root:"items",totalProperty:"total"}},fields:[{name:"_id",type:"String"},{name:"type",type:"String"},{name:"tokens",type:"Number"},{name:"timestamp",type:"Date",dateFormat:"c"},{name:"contest",type:"Object"},{name:"page",type:"Object"},{name:"user",type:"Object"}],getEntryType:function(){var b=this,a;try{switch(b.get("type")){case"bozuko/checkin":a="Bozuko Checkin";break;case"bozuko/nothing":a="Bozuko Play";break;case"facebook/like":a="Facebook Like";break;case"facebook/checkin":a="Facebook Checkin";break;default:throw c}}catch(c){a="Unknown"}return a}},function(){this.prototype.proxy.url=Bozuko.Router.route(this.prototype.proxy.url)});Ext.define("Bozuko.model.Winner",{extend:"Ext.data.Model",idProperty:"_id",requires:["Bozuko.lib.Router"],proxy:{type:"rest",url:"/winners",reader:{type:"json",root:"items",totalProperty:"total"}},fields:[{name:"_id",type:"String"},{name:"contest_id",type:"String"},{name:"prize",type:"Object"},{name:"contest",type:"Object"},{name:"page",type:"Object"},{name:"user",type:"Object"}]},function(){this.prototype.proxy.url=Bozuko.Router.route(this.prototype.proxy.url)});Ext.define("Bozuko.lib.form.field.Codes",{extend:"Ext.form.field.TextArea",alias:"widget.codes",delimiter:"\n",getValue:function(){var b=Ext.form.field.TextArea.prototype.getRawValue.apply(this),c=[],a=b.replace(/\r/,"").replace(/^\n+/,"").replace(/\n+$/,"").split(this.delimiter);for(var d=0;d<a.length;d++){if(a[d]!==""){c.push(a[d])}}return c},setValue:function(a){if(Ext.isString(a)){a=a.split(this.delimiter)}return this.callParent([(a||[]).join(this.delimiter)])}});Ext.define("Bozuko.store.Games",{extend:"Ext.data.Store",fields:["img","title","description","game"],data:[{game:"slots",title:"Slot Machine",img:"/games/slots/slots_icon3.png",description:["<p>Players spin a slot machine to win prizes. Three icons in a row and they win!</p>"].join("")},{game:"scratch",title:"Scratch Ticket",img:"/games/scratch/themes/default/scratch.png",description:["<p>Players scratch six positions on a scratch ticket to win prizes. ","If any three positions match they win! </p>"].join("")}]},function(){Ext.create("Bozuko.store.Games",{storeId:"games"})});Ext.define("Bozuko.model.Page",{extend:"Bozuko.lib.data.Model",idProperty:"_id",proxy:{type:"rest",url:"/pages",reader:{type:"json",root:"items",totalProperty:"total"}},fields:[{name:"_id",type:"String"},{name:"name",type:"String"},{name:"category",type:"String"},{name:"website",type:"String"},{name:"image",type:"String"},{name:"twitter_id",type:"String"},{name:"featured",type:"Boolean"},{name:"announcement",type:"String"},{name:"active",type:"Boolean"},{name:"location",type:"Object"},{name:"coords",type:"Array"},{name:"test",type:"Boolean"},{name:"security_img",type:"String"},{name:"services",type:"Array"},{name:"admins",type:"Array"}],service:function(a){var d=this,c=this.get("services");for(var b=0;b<c.length;b++){if(c[b].name==a){return c[b]}}return false}},function(){this.prototype.proxy.url=Bozuko.Router.route(this.prototype.proxy.url)});Ext.define("Bozuko.controller.Pages",{extend:"Bozuko.lib.app.Controller",requires:["Bozuko.lib.app.Controller","Bozuko.model.Page"],views:[],stores:[],models:[],refs:[],init:function(){var a=this;a.control({pagepanel:{render:a.onPagePanelRender},"[ref=navigation] button":{click:a.changePage},"[ref=statusField]":{render:a.onStatusFieldRender},"button[ref=updateStatus]":{click:a.updateStatus},"pagesettings [action=save]":{click:a.saveSettings},pagesettings:{save:function(b){a.saveSettings(b.down("button[action=save]"))}}})},onPagePanelRender:function(g){var f=this,d=g.page,a=g.down("button[ref=updateStatus]"),c=a.getText();var h=function(){a.setText("Updating Announcement...");a.disable()};var e=function(){a.setText(c);a.enable();g.down("[ref=statusField]").setValue(d.get("announcement"));g.down("pagesettings").loadRecord(d);g.successStatus("Page Saved");Ext.select(".page-info img").each(function(j){j.dom.src=d.get("image")})};d.on("beforesave",h);d.on("save",e);g.on("destroy",function(){d.un("beforesave",h);d.un("save",e)});var i=g.down("[ref=pages]").getLayout().getActiveItem();var b=g.down("[ref=navigation] button[page="+i.ref+"]");b.on("render",b.toggle,b)},onStatusFieldRender:function(b){var a=this,c=b.up("pagepanel");b.setValue(c.page.get("announcement"))},updateStatus:function(a){var b=this,d=a.up("pagepanel"),c=d.page;c.set("announcement",d.down("[ref=statusField]").getValue());c.save()},getValues:function(c,a){var b={};a=a?a+" field":"field";Ext.Array.each(c.query(a),function(f){var d=f.getName().split("."),g=b;if(d.length>1){while(d.length>1){var e=d.shift();if(!g[e]){g[e]={}}g=g[e]}}g[d.shift()]=f.getValue()});return b},changePage:function(b){var d=this,f=b.up("pagepanel"),c=b.up("toolbar");c.items.each(function(g){if(g.xtype=="button"&&g.pressed){g.toggle()}});if(!b.pressed){b.toggle()}var a=f.down("[ref=pages]"),e=a.down("> [ref="+b.page+"]");if(!e){return}if(a.getLayout().getActiveItem()===e){return}a.getLayout().setActiveItem(e);e.doComponentLayout()},saveSettings:function(d){var c=this,b=d.up("form"),a=this.getValues(b);b.record.set(a);b.record.commit();d.disable();b.record.save({callback:function(){d.enable()},failure:function(){alert("Error Saving Page")}})}});Ext.define("Bozuko.view.contests.Panel",{alias:"widget.contestspanel",extend:"Ext.panel.Panel",requires:["Bozuko.lib.PubSub","Bozuko.view.contest.List"],initComponent:function(){var a=this;var b=Ext.create("Ext.toolbar.Toolbar",{ref:"contestreport-navbar",cls:"title-toolbar",defaults:{xtype:"button",scale:"medium",iconAlign:"left"},items:[{xtype:"tbtext",text:"All Campaigns"}]});b.add("-",{hidden:false,action:"builder",text:"Create a Campaign",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/plus-24.png"});Ext.apply(a,{bodyCls:"contestpanel",layout:"card",activeItem:0,items:[{xtype:"panel",layout:"fit",border:false,tbar:b,items:[{xtype:"contestlist",store:a.store,autoScroll:true,actionButtons:Bozuko.beta?["report","edit","copy","delete"]:null}]}]});a.callParent(arguments)}});Ext.define("Bozuko.view.page.Settings",{extend:"Ext.form.Panel",alias:"widget.pagesettings",requires:["Bozuko.view.page.Preview"],autoScroll:true,layout:"border",initComponent:function(){var c=this;Ext.apply(c,{items:[{region:"center",border:false,layout:"anchor",autoScroll:true,style:"border-right: 1px solid #ccc;",defaults:{xtype:"fieldset",margin:"10",layout:"anchor",style:"background-color: #f3f3f3"},tbar:[{text:"Save",action:"save",scale:"medium",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-circle-check-24.png"}],items:[{title:"Basic Information",layout:"hbox",items:[{xtype:"container",border:false,autoHeight:true,layout:"anchor",flex:1,defaults:{border:false,anchor:"0"},items:[{},{xtype:"textfield",name:"name",fieldLabel:"Name"},{xtype:"textfield",name:"category",fieldLabel:"Category"},{xtype:"textfield",name:"website",fieldLabel:"Website"}]},{xtype:"splitter",width:10},{xtype:"container",ref:"profile-pic-ct",border:false,fieldLabel:"Profile Image",layout:{type:"vbox",align:"center"},autoHeight:true,labelAlign:"top",width:100,height:90,items:[{xtype:"component",ref:"profile-pic",tpl:new Ext.XTemplate('<img src="{[this.image(values.image)]}" height="60" />',{image:function(d){return d.replace(/type=large/,"type=square")}})},{xtype:"button",text:"Change Image",handler:c.openImageDialog,scope:c}]}]},{title:"Address",defaults:{anchor:"0"},items:[{xtype:"textfield",name:"location.street",fieldLabel:"Street"},{xtype:"textfield",name:"location.city",fieldLabel:"City"},{xtype:"textfield",name:"location.state",fieldLabel:"State"},{xtype:"textfield",name:"location.zip",fieldLabel:"Zip"}]},{title:"Security Image",items:[{xtype:"dataview",ref:"security-image-view",trackOver:true,singleSelect:true,itemSelector:".item",overItemCls:"item-over",selectedItemCls:"item-selected",tpl:new Ext.XTemplate('<div class="security-images">','<div class="scroller">','<tpl for=".">','<div class="item" style="left: {[(xindex-1)*75]}px">','<img src="{signedUrl}" />',"</div>","</tpl>","</div>","</div>"),store:Ext.create("Ext.data.Store",{fields:["signedUrl","path"],proxy:{type:"rest",url:Bozuko.Router.route("/security/images"),reader:{type:"json",root:"items"}},autoLoad:true}),listeners:{beforecontainerclick:function(d,f){return false},selectionchange:function(d,e){if(e&&e.length){c.record.set("security_img",e[0].get("path"))}},refresh:function(d){var e=d.store.findRecord("path",c.record.get("security_img")||"security/sun.png");if(e){d.select(e)}}}}]},{title:"Business",defaults:{anchor:"0"},items:[{xtype:"textarea",height:60,name:"announcement",fieldLabel:"Announcement"}]}]},{region:"east",title:"Page Preview",xtype:"pagepreview",border:false,autoScroll:true}]});c.callParent(arguments);if(c.record){c.loadRecord(c.record);var b=Ext.Function.createBuffered(function(){c.down("[ref=profile-pic-ct]").doLayout();c.down("[ref=profile-pic-ct]").doComponentLayout()},200);c.record.on("save",b);c.on("destroy",function(){c.record.un("save",b)})}var a=c.down("pagepreview");c.on("activate",c.onActivate,c)},onActivate:function(){var g=this,c=g.down("pagepreview"),b=g.down("[ref=security-image-view]"),d=b.getSelectedNodes();if(!d||!d.length){return}var f=Ext.get(d[0]),a=Ext.fly(f).up(".scroller"),h=f.getLeft(true),e=a.getWidth();a.scrollTo("l",h-(e/2)+35)},openImageDialog:function(){var a=this;if(!a._imageDialog){a._imageDialog=Ext.create("Ext.window.Window",{title:"Change Profile Picture",layout:"fit",width:450,modal:true,autoHeight:true,items:[{xtype:"form",layout:"hbox",url:Bozuko.Router.route("/page/image?"+Date.now()),baseParams:{page_id:a.record.get("_id")},autoHeight:true,bodyPadding:10,border:false,items:[{xtype:"component",width:100,tpl:new Ext.XTemplate('<img src="{[this.image(values.image)]}" height="70" />',{image:function(b){return b.replace(/type=large/,"type=square")}}),data:a.record.data},{xtype:"container",flex:1,autoHeight:true,border:false,layout:"anchor",defaults:{anchor:"0"},items:[{xtype:"component",html:'Please choose a new profile image from your computer and then hit "Upload". <br /><br /><span style="font-size:11px; color: #666;">The image should be at least 150px x 150px.</span><br />'},{xtype:"filefield",name:"image",hideLabel:true,buttonText:"Select Image..."}]}]}],buttonAlign:"left",buttons:[{text:"Use Facebook Picture",handler:function(){var b="https://graph.facebook.com/"+a.record.service("facebook").sid+"/picture?type=large";if(a.down("[name=image]")){a.down("[name=image]").setValue(b)}a.record.set("image",b);a.fireEvent("save",a);a._imageDialog.close()}},"->",{text:"Cancel",handler:function(){a._imageDialog.close()}},{text:"Upload",handler:function(){a._imageDialog.setLoading("Uploading...");a._imageDialog.down("form").submit({success:function(b,c){a._imageDialog.setLoading(false);a.record.set("image",c.result.url);if(a.down("[name=image]")){a.down("[name=image]").setValue(c.result.url)}a.fireEvent("save",a);a._imageDialog.close()},failure:function(b,c){a._imageDialog.setLoading(false);alert(c.result.err)}})}}],listeners:{destroy:function(){delete a._imageDialog}}})}a._imageDialog.show()},loadRecord:function(b){var d=this;d.callParent(arguments);d.record=b;d.down("[ref=profile-pic]").update(d.record.data);var a=b.get("location");var c={};if(a){Ext.Object.each(a,function(e,f){c["location."+e]=f})}c.betalink=window.location.protocol+"//"+window.location.host+"/beta/page/"+b.get("_id");c.sharelink=window.location.protocol+"//"+window.location.host+"/p/"+b.get("_id");d.getForm().setValues(c);d.down("pagepreview").loadRecord(b)}});Ext.define("Bozuko.view.contest.edit.Prizes",{extend:"Ext.form.Panel",alias:"widget.contestformprizes",requires:["Bozuko.view.contest.edit.Prize"],autoScroll:true,initComponent:function(){var a=this;a.addBtn=Ext.create("Ext.button.Button",{scale:"medium",text:"Add Prize",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-circle-plus-24.png",handler:a.createPrize,scope:a});a.items=[a.addBtn];if(a.store){a.updateForms()}a.callParent();a.on("activate",a.doLayout,a)},bindStore:function(a){this.store=a;this.clearPrizes();this.updateForms()},clearPrizes:function(){Ext.Array.each(this.query("contestformprize"),function(a){a.ownerCt.remove(a)})},updateForms:function(){var a=this;if(!a.store){return}a.store.each(a.addPrize,a);a.doLayout()},createPrize:function(){var a=this,b=Ext.create("Bozuko.model.Prize");a.store.add(b);a.addPrize(b);a.doLayout()},addPrize:function(d){var c=this,a=c.items.indexOf(c.addBtn),b=c.insert(a,{xtype:"contestformprize",border:false,listeners:{removeprize:c.onRemovePrize,scope:c}});b.record=d;b.loadRecord(d)},onRemovePrize:function(c,b){var a=this;Ext.Msg.confirm("Remove Prize","Are you sure you would like to remove this prize?",function(d){if(d!="yes"){return}a.remove(b);a.store.remove(c)});a.doLayout()},updateRecords:function(){Ext.Array.each(this.query("contestformprize"),function(a){a.updateRecord()})}});Ext.define("Bozuko.view.contest.edit.ConsolationPrizes",{extend:"Bozuko.view.contest.edit.Prizes",alias:"widget.contestformconsolationprizes",initComponent:function(){var a=this;a.callParent(arguments);a.insert(0,{xtype:"panel",layout:"anchor",border:false,items:[{xtype:"fieldset",title:"Consolation Configuration",defaults:{anchor:"0",labelWidth:220},items:[{xtype:"checkbox",name:"enabled",fieldLabel:"Enable Consolation Prizes"},{xtype:"combo",name:"who",fieldLabel:"Which players should recieve?",store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:"all",text:"All players"},{value:"losers",text:"Only players that lost"}]}),displayField:"text",valueField:"value"},{xtype:"combo",name:"when",fieldLabel:"When should players receive?",store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:"always",text:"Players receive a consolation prize with every entry"},{value:"once",text:"Players will only receive one consolation per contest"},{value:"interval",text:"At the given interval below"}]}),displayField:"text",valueField:"value"},{xtype:"textfield",name:"duration",fieldLabel:"Interval (only when above is interval)"}]}]})}});Ext.define("Bozuko.model.Contest",{extend:"Bozuko.lib.data.Model",idProperty:"_id",requires:["Ext.ux.data.writer.JsonDeep","Bozuko.lib.Router","Bozuko.model.Prize"],proxy:{type:"rest",url:"/contests",reader:{type:"json",root:"items"},writer:{type:"jsondeep"}},fields:[{name:"_id",type:"String"},{name:"page_id",type:"String"},{name:"name",type:"String",defaultValue:"Untitled Campaign"},{name:"win_frequency",type:"Number",defaultValue:2},{name:"engine_type",type:"String"},{name:"engine_options",type:"Object",defaultValue:{mode:"odds"}},{name:"game",type:"String",defaultValue:"slots"},{name:"game_config",type:"Object",defaultValue:{theme:"default"}},{name:"auto_rules",type:"Boolean",defaultValue:true},{name:"rules",type:"String"},{name:"entry_config",type:"Array",defaultValue:[{type:"facebook/checkin",tokens:3,duration:1000*60*60*24}]},{name:"consolation_config",type:"Array"},{name:"free_play_pct",type:"Number",defaultValue:"30%"},{name:"active",type:"Boolean"},{name:"state",type:"String"},{name:"start",type:"Date",dateFormat:"c",defaultValue:(function(){var a=new Date();a.setMinutes(0);return a})()},{name:"end",type:"Date",dateFormat:"c",defaultValue:(function(){var a=new Date();a.setMinutes(0);a=Ext.Date.add(a,Ext.Date.DAY,90);return a})()},{name:"total_entries",type:"Number"},{name:"total_plays",type:"Number"},{name:"post_to_wall",type:"Boolean",defaultValue:true},{name:"play_cursor",type:"Number",defaultValue:-1},{name:"token_cursor",type:"Number",defaultValue:0}],hasMany:[{model:"Bozuko.model.Prize",name:"prizes",associationKey:"prizes"},{model:"Bozuko.model.Prize",name:"consolation_prizes",associationKey:"consolation_prizes"}],autoLoad:true,getEntryConfig:function(b){var c=this,a=c.get("entry_config");if(!a||!a.length){if(!b){return false}c.set("entry_config",[{}]);a=c.get("entry_config")}return a[0]},getEntryType:function(g){var c=this,b;var a=c.get("entry_config");if(a&&a.length){a=a[0]}else{a={}}try{switch(a.type){case"bozuko/checkin":b="Bozuko Checkin";break;case"bozuko/nothing":b="Bozuko Play";break;case"facebook/like":b="Facebook Like";break;case"facebook/checkin":try{if(a.options.enable_like){b="Facebook Checkin w/ Like Bonus"}else{throw""}}catch(f){b="Facebook Checkin"}break;case"":return"";default:throw""}}catch(f){b="Unknown"}if(g!==false){var d=a.tokens||0;return b+" ("+d+" plays)"}return b},getGameName:function(){switch(this.get("game")){case"slots":return"Slot Machine";case"scratch":return"Scratch Ticket"}return""},getTotalEntries:function(){var b=this,d=0;b.prizes().each(function(e){d+=e.get("total")});try{var a=b.get("entry_config")[0];if(a.type=="facebook/checkin"&&a.options.enable_like){d*=2}}catch(c){}return Math.ceil(d*b.get("win_frequency"))},getEntryCount:function(){var a=this;return Math.floor((a.get("token_cursor"))/a.get("entry_config")[0].tokens)},getWonPrizeCount:function(){var a=this,b=0;a.prizes().each(function(c){b+=(c.get("won")||0)});return b},getTotalPrizeCount:function(){var a=this,b=0;a.prizes().each(function(c){b+=c.get("total")});return b},getRedeemedPrizeCount:function(){var a=this,b=0;a.prizes().each(function(c){b+=(c.get("redeemed")||0)});return b},getPrizeCount:function(){return this.prizes().getCount()},getPrizeOdds:function(a){var c=this.prizes().getAt(a),b=c.get("total"),d=Number(this.get("total_entries"));if(!this.get("total_entries")){return""}return"1 in "+((d/b).toFixed(1))},getPrizePlayOdds:function(a){var c=this.prizes().getAt(a),b=c.get("total");return"1 in "+((this.getTotalPlays()/b).toFixed(1))},getTotalPlays:function(){var b=Number(this.get("total_entries")),a=this.getEntryConfig(true).tokens||2;total_plays=Math.ceil(b*a);return total_plays},getGCD:function(a,d){var c,b=0;while(d!=0&&b++<100){c=a%d;a=d;d=c}return a},getTotalPrizesValue:function(){var a=this,b=0;a.prizes().each(function(c){b+=(c.get("total")*c.get("value"))});return b}},function(){this.prototype.proxy.url=Bozuko.Router.route(this.prototype.proxy.url)});Ext.define("Bozuko.store.Contests",{extend:"Ext.data.Store",requires:["Ext.data.reader.Json","Bozuko.model.Contest"],model:"Bozuko.model.Contest",constructor:function(){this.callParent(arguments);this.on("beforeload",this.onBeforeLoad,this)},onBeforeLoad:function(b,a){if(!this.page_id){return}if(!a.params){a.params={}}a.params.page_id=this.page_id}});Ext.define("Bozuko.view.contest.builder.card.Entry",{extend:"Bozuko.view.contest.builder.Card",alias:"widget.contestbuilderentry",requires:["Bozuko.view.contest.builder.Card","Bozuko.lib.form.field.Duration","Bozuko.store.EntryTypes"],name:"Entry Method",overview:["<p>This is the requirement for users to enter your game.  Each entry type has ","unique benefits for your business.  Select an entry method to learn more.</p>"],initComponent:function(){var a=this;var b=Ext.id();Ext.apply(a.form,{items:[{xtype:"dataview",trackOver:true,overItemCls:"x-dataview-item-over",itemSelector:".entry-method",cls:"select-list2 entry-list",emptyText:"No Entry Methods",deferEmptyText:false,singleSelect:true,tpl:new Ext.XTemplate('<div class="entry-methods list-items">','<tpl for=".">','<div class="entry-method x-dataview-item">','<input style="position: absolute; left: -99999em;" type="radio" name="focus_field" />','<img src="{img}" />','<div class="title">{title}</div>',"</div>","</tpl>","</div>",'<div class="entry-description selection-description"></div>'),store:Ext.create("Bozuko.store.EntryTypes"),listeners:{selectionchange:a.onSelectionChange,scope:a,render:a.watchOptions,refresh:function(){a.watchOptions();a.loadEntry()},beforecontainerclick:function(){return false}}},{xtype:"duration",name:"entry_config.duration",fieldLabel:"Users can play every",emptyText:"Please enter a number",helpLabel:"Play Frequency",helpText:["<p>How often are players allowed to enter the game?</p>"]}]});a.callParent(arguments);a.dataview=a.down("dataview")},loadContest:function(){var d=this,b={},a=d.contest.getEntryConfig(true);for(var c in a){b["entry_config."+c]=a[c]}d.form.getForm().setValues(b)},loadEntry:function(){var e=this,b=e.contest.getEntryConfig();if(!b){return}var a=e.dataview.store.findRecord("type",b.type);if(!a){return}e.dataview.select(a);var d=e.dataview.getNode(a),c=Ext.fly(d).select("input");c.each(function(f){var g=b.options[f.getAttribute("name")];if(f.getAttribute("type")=="checkbox"){f.checked=g}else{f.value=g}})},watchOptions:function(){var a=this;a.dataview.getEl().select(".options input").on("change",a.updateRecord,a)},validate:function(){var b=this,a=b.dataview.getSelectionModel().getSelection();if(!a.length){return"Please select on the entry types before going to the next step."}if(!b.down("[name=entry_config.duration]").getValue()){b.down("[name=entry_config.duration] textfield").markInvalid("This field is required");return"Entry Duration is required"}return true},updateRecord:function(){var f=this,a=f.getValues(),d=f.dataview.getSelectionModel().getSelection(),c=f.contest.getEntryConfig(true);if(!d.length){c.type=""}else{c.type=d[0].get("type");c.options={};var e=f.dataview.getNode(d[0]),b=Ext.fly(e).select("input");b.each(function(g){var h;if(g.getAttribute("name")=="focus_field"){return}if(g.getAttribute("type")=="checkbox"){h=g.dom.checked}else{h=g.getValue()}c.options[g.getAttribute("name")]=h})}c.duration=f.form.down("[name=entry_config.duration]").getValue();f.contest.set("entry_config",[c])},onSelectionChange:function(a,b){var c=this;if(b.length){c.dataview.getEl().down(".entry-description").update(b[0].get("description"))}c.updateRecord()}});Ext.define("Bozuko.view.contest.builder.card.Game",{extend:"Bozuko.view.contest.builder.Card",alias:"widget.contestbuildergame",requires:["Bozuko.view.contest.builder.Card","Ext.tip.ToolTip"],name:"Game",overview:["<p>Choose one of our <em>addictively simple</em> games for your campaign!</p>"],initComponent:function(){var a=this;a.currentGame=null;Ext.apply(a.form,{items:[{xtype:"dataview",trackOver:true,overItemCls:"x-dataview-item-over",cls:"select-list2 game-list",emptyText:"No Games",deferEmptyText:false,singleSelect:true,itemSelector:".x-dataview-item",tpl:new Ext.XTemplate('<div class="games list-items">','<tpl for=".">','<div class="game x-dataview-item">','<input style="position: absolute; left: -99999em;" type="radio" name="focus_field" />','<img src="{img}" />','<div class="title">{title}</div>',"</div>","</tpl>","</div>",'<div class="entry-description selection-description"></div>'),store:Ext.create("Ext.data.Store",{fields:["img","title","description","game"],data:[{game:"slots",title:"Slot Machine",img:"/games/slots/slots_icon3.png",description:["<p>Players spin a slot machine to win prizes. Three icons in a row and they win!</p>"].join("")},{game:"scratch",title:"Scratch Ticket",img:"/games/scratch/themes/default/scratch.png",description:["<p>Players scratch six positions on a scratch ticket to win prizes. ","If any three positions match they win! </p>"].join("")}]}),listeners:{selectionchange:a.onSelectionChange,scope:a,refresh:function(){a.loadGame()},beforecontainerclick:function(){return false}}},{xtype:"textfield",emptyText:"Leave blank for default name (Slots, Scratch, etc)",name:"game_config.name",fieldLabel:"Game Name",helpText:["<p>","This is the public name of this game.  Have some fun with it!","</p>","<p>","Example: Car Wash Slots","</p>"]},{xtype:"fieldcontainer",ref:"last-field",border:false,fieldLabel:"Plays per Entry",helpText:["<p>This is how many times a user can play the game for each entry. ",'<span style="text-decoration:underline;">This does not affect the average odds per player</span>. ',"Use multiple plays to extend the play time or allow players to win multiple prizes.","</p>","<p>","Example 1: A bar may give players 3 spins at a slot machine.<br /><br />","Example 2: A gas station may give players a single scratch ticket.","</p>"],layout:"hbox",items:[{xtype:"combo",ref:"last-field",name:"entry_config.tokens",hideLabel:true,minValue:1,maxValue:20,width:50,allowBlank:false,editable:false,forceSelection:true,displayField:"value",valueField:"value",queryMode:"local",store:Ext.create("Ext.data.Store",{fields:["value"],data:[{value:1},{value:2},{value:3},{value:4},{value:5}]})}]}]});a.callParent(arguments);a.on("activate",a.updateOptions,a);a.dataview=a.down("dataview")},updateOptions:function(){var b=this;if(b.currentGame==b.contest.get("game")){return}var a=b.form.items.indexOf(b.down("[ref=last-field]"));while(b.form.items.getCount()>a+1){b.form.remove(b.form.items.getAt(a+1))}b.currentGame=b.contest.get("game");b.addThemeChooser(b.currentGame)},loadContest:function(){var c=this,a={};c.entry_cfg=c.contest.getEntryConfig(true),c.game_cfg=c.contest.get("game_config")||{};if(c.entry_cfg){for(var b in c.entry_cfg){a["entry_config."+b]=c.entry_cfg[b]}}if(c.game_cfg){for(var b in c.game_cfg){a["game_config."+b]=c.game_cfg[b]}}c.form.getForm().setValues(a)},loadGame:function(){var c=this,b=c.contest.get("game");if(!b){return}var a=c.dataview.store.findRecord("game",b);if(!a){return}c.dataview.select(a)},validate:function(){var b=this,a=b.dataview.getSelectionModel().getSelection();b.updateRecord();if(!a.length){return"Please select on the entry types before going to the next step."}return true},updateRecord:function(){var d=this,c=d.dataview.getSelectionModel().getSelection(),b=d.getValues(),a=null;if(c.length){a=c[0].get("game")}Ext.apply(d.game_cfg,b.game_config);Ext.apply(d.entry_cfg,b.entry_config);d.contest.set("game_config",d.game_cfg);d.contest.set("game",a)},onSelectionChange:function(a,b){var c=this;if(b.length){c.dataview.getEl().down(".entry-description").update(b[0].get("description"))}c.updateRecord();c.updateOptions()},onThemesLoad:function(b){var d=this,c=b.find("theme",d.game_cfg.theme);if(!~c){c=b.find("theme","default")}if(~c){var a=d.down("[ref=theme-chooser]");if(a){a.getSelectionModel().select(c)}}d.doLayout()},addThemeChooser:function(b){var c=this;c.form.add({xtype:"component",autoEl:{tag:"div",html:"Choose a theme:"}},{xtype:"dataview",ref:"theme-chooser",trackOver:true,overItemCls:"theme-over",fieldLabel:"Theme",labelAlign:"top",cls:"theme-list",emptyText:"No Themes Available",deferEmptyText:false,singleSelect:true,height:230,itemSelector:".theme",tpl:new Ext.XTemplate('<div class="themes">','<tpl for=".">','<div class="theme">','<div class="theme-content">','<input style="position: absolute; top: -99999em; left: -99999em;" type="radio" name="focus_field" />','<div class="title">{title}</div>','<img src="{icon}" />','<div class="description">{description}</div>',"</div>","</div>","</tpl>","</div>"),store:Ext.create("Ext.data.Store",{fields:["title","preview","description","theme","icon"],proxy:{type:"rest",url:Bozuko.Router.route("/themes/"+b+"/"+encodeURIComponent(c.up("pagepanel").page.get("name"))),reader:{type:"json",root:"items"}},autoLoad:true,listeners:{scope:c,load:c.onThemesLoad}}),listeners:{beforecontainerclick:function(d,f){return false},selectionchange:function(d,e){if(e&&e.length){c.game_cfg.theme=e[0].get("theme")}},render:function(d){d.tip=Ext.create("Ext.tip.ToolTip",{target:d.el,height:222,width:172,delegate:d.itemSelector,trackMouse:true,renderTo:Ext.getBody(),listeners:{beforeshow:function e(g){var f=d.getRecord(g.triggerElement),h=f.get("preview");g.update('<img src="'+h+'" height="210" />')}}})}}});var a=c.down("[ref=theme-chooser]")}});Ext.define("Bozuko.view.contest.edit.Preview",{extend:"Ext.panel.Panel",alias:"widget.contestformpreview",requires:["Bozuko.model.Contest"],cls:"campaign-preview",width:200,bodyPadding:10,border:false,autoScroll:true,title:"Campaign Preview",html:"Test",initComponent:function(){var a=this;a.callParent(arguments)}});Ext.define("Bozuko.view.contest.builder.card.Odds",{extend:"Bozuko.view.contest.builder.Card",alias:"widget.contestbuilderodds",requires:["Bozuko.view.contest.builder.Card","Bozuko.lib.form.field.WinFrequency"],name:"Contest Odds",cls:"builder-card contest-odds-card",overview:[],oddsText:"Overall Odds per Entry",entryText:"Total Player Entries",initComponent:function(){var b=this;b.engine_options=b.contest.get("engine_options");b.mode=b.engine_options.mode||"odds";Ext.apply(b.form,{items:[{xtype:"component",ref:"intro",autoEl:{tag:"h2"},html:b.getIntroHTML()},{xtype:"container",border:false,layout:"anchor",height:50,defaults:b.form.defaults,items:[{xtype:"winfrequencyfield",name:"win_frequency",xmode:"odds",hideLabel:true,helpText:["<p>Enter the overall odds that a player wins any prize when they enter this game. ","Note the effect overall odds have on individual prize odds and the total number of entries.</p>","<p>Example:  If the overall odds are 1 in 4, you would expect that for every four players, on average one will win a prize.</p>"],listeners:{scope:b,change:b.updateContest}},{xtype:"container",arrowCt:"true",style:"position:relative; overflow: visible",layout:{type:"hbox",pack:"center"},border:false,items:[{xtype:"textfield",name:"total_entries",xmode:"entry",style:"text-align:center;",maskRE:/0-9/,hidden:true,disabled:true,fieldLabel:"Total Entries",hideLabel:true,width:100,helpText:["<p>Enter the total number of player entries you would like for this game.  Note the effect your total number of entries has on the overall odds.</p>","<p>Example: If you have 10 total prize quantity and enter 100 total entries, the overall odds of any player entry winning is 1 in 10.</p>"],listeners:{scope:b,change:b.updateContest}}]},{xtype:"container",border:false,style:"text-align:center; position: relative;margin-bottom: 20px;",items:[{xtype:"component",ref:"switcher",autoEl:{tag:"a",cls:"switcher",href:"/",style:{position:"absolute",right:"0px",bottom:"0px"}},listeners:{render:b.initSwitcher,scope:b}}]}]},{xtype:"dataview",store:b.contest.prizes(),itemSelector:".prize-odds",trackOver:false,tpl:new Ext.XTemplate('<div class="odds-tables">','<div class="overview">','<div class="alternate">{[this.getAlternate()]}</div>',"</div>",'<div class="prizes-odds">',"<table>","<tr>","<th>Prize Name</th>","<th>Quantity</th>","<th>Odds per Play</th>","<th>Odds per Entry</th>","</tr>",'<tpl for=".">','<tr class="prize-odds">','<td class="prize-name">{name}</td>','<td class="prize-total">{total}</td>','<td class="prize-odds-value">',"{[this.getPrizePlayOdds(xindex)]}","</td>",'<td class="prize-odds-value">',"{[this.getPrizeOdds(xindex)]}","</td>","</tr>","</tpl>",'<tr class="footer">',"<th>Total</th>","<td>{[this.totalPrizes()]}</td>","<td>{[this.overallPlayOdds()]}</td>","<td>{[this.overallEntryOdds()]}</td>","</tr>","</table>","</div>","</div>",{getAlternate:function(){if(b.mode=="odds"){return"<strong>"+b.contest.get("total_entries")+"</strong> Total Entries"}else{return"1 in <strong>"+b.contest.get("win_frequency").toFixed(1)+"</strong> Overall Odds"}},totalEntries:function(){return b.contest.get("total_entries").getValue()},totalPlays:function(){return b.contest.getTotalPlays()},totalPrizes:function(){return b.contest.getTotalPrizeCount()},overallPlayOdds:function(){var c=b.contest.getTotalPlays()/b.contest.getTotalPrizeCount();return"1 in "+c.toFixed(1)},overallEntryOdds:function(){var c=b.contest.get("total_entries")/b.contest.getTotalPrizeCount();return"1 in "+c.toFixed(1)},getPrizeOdds:function(c){return b.contest.getPrizeOdds(c-1)},getPrizePlayOdds:function(c){return b.contest.getPrizePlayOdds(c-1)}})}]});b.callParent(arguments);b.intro=b.down("[ref=intro]");var a=Ext.Function.createBuffered(b.onStoreUpdate,10,b);b.contest.prizes().on("update",a);b.contest.prizes().on("add",a);b.contest.prizes().on("remove",a);b.on("destroy",function(){b.contest.prizes().un("update",a);b.contest.prizes().un("add",a);b.contest.prizes().un("remove",a)});b.on("activate",function(){b.updateContest();b.hideFields(b.mode=="odds"?"entry":"odds");b.showFields(b.mode!="odds"?"entry":"odds")})},loadContest:function(){var a=this;if(a.mode=="odds"){a.down("[name=win_frequency]").setValue(a.contest.get("win_frequency")||2)}else{a.down("[name=total_entries]").setValue(a.contest.get("total_entries")||500)}},initSwitcher:function(b){var a=this;b.update(a.mode=="odds"?"Switch to<br />Total Entry Mode":"Switch to<br />Average Odds Mode");b.getEl().on("click",function(c){c.preventDefault();a.switchMode()})},updateContest:function(){var a=this;if(a.mode=="odds"){a.contest.set("win_frequency",Number(a.down("[name=win_frequency]").getValue()));a.contest.set("total_entries",Math.ceil(a.down("[name=win_frequency]").getValue()*a.contest.getTotalPrizeCount()));a.down("[name=total_entries]").setValue(a.contest.get("total_entries"))}else{a.contest.set("total_entries",Number(a.down("[name=total_entries]").getValue()));a.contest.set("win_frequency",(Number(a.down("[name=total_entries]").getValue())/a.contest.getTotalPrizeCount()).toFixed(2));a.down("[name=win_frequency]").setValue(a.contest.get("win_frequency"))}a.down("dataview").refresh()},onStoreUpdate:function(){this.updateContest()},switchMode:function(){var a=this;a.hideFields(a.mode);a.mode=a.mode=="odds"?"entry":"odds";a.engine_options.mode=a.mode;a.intro.update(a.getIntroHTML());a.showFields(a.mode);a.down("[ref=switcher]").update(a.mode=="odds"?"Switch to<br />Total Entry Mode":"Switch to<br />Average Odds Mode");a.down("dataview").refresh();a.form.doLayout()},hideFields:function(b){var a=this;Ext.each(a.query("[xmode="+b+"]"),function(c){c.hide();c.disable()})},showFields:function(b){var a=this;Ext.each(a.query("[xmode="+b+"]"),function(c){c.show();c.enable();c.focus()})},onFieldBlur:function(){},getIntroHTML:function(b){var a=this;b=b||a.mode;return a[a.mode=="odds"?"oddsText":"entryText"]}});Ext.define("Ext.ux.form.field.DateTime",{extend:"Ext.form.field.Date",alias:"widget.datetimefield",requires:["Ext.ux.picker.DateTime"],showTime:true,dateFormat:"m/d/Y h:i a",createPicker:function(){var a=this,b=Ext.String.format;return Ext.create("Ext.ux.picker.DateTime",{ownerCt:a.ownerCt,renderTo:document.body,floating:true,hidden:true,focusOnShow:true,minDate:a.minValue,maxDate:a.maxValue,disabledDatesRE:a.disabledDatesRE,disabledDatesText:a.disabledDatesText,disabledDays:a.disabledDays,disabledDaysText:a.disabledDaysText,format:a.format,showToday:a.showToday,showTime:a.showTime,startDay:a.startDay,minText:b(a.minText,a.formatDate(a.minValue)),maxText:b(a.maxText,a.formatDate(a.maxValue)),listeners:{scope:a,select:a.onSelect,timechange:function(c){a.setValue(c)}},keyNavConfig:{esc:function(){a.collapse()}}})}});Ext.define("Bozuko.view.contest.edit.Details",{extend:"Ext.form.Panel",alias:"widget.contestformdetails",requires:["Ext.ux.form.field.DateTime"],layout:"anchor",defaults:{anchor:"0",labelWidth:150},initComponent:function(){var a=this;a.items=[{xtype:"textfield",name:"name",fieldLabel:"Name"},{xtype:"datetimefield",name:"start",format:"m/d/Y g:i:s A",value:new Date(),fieldLabel:"Start Date"},{xtype:"datetimefield",name:"end",format:"m/d/Y g:i:s A",value:Ext.Date.add(new Date(),Ext.Date.DAY,14),fieldLabel:"End Date"},{xtype:"textfield",name:"win_frequency",fieldLabel:"Win Frequency"},{xtype:"checkbox",name:"post_to_wall",fieldLabel:"Post Wins to User's Wall"},{xtype:"checkbox",name:"active",fieldLabel:"Active"}];a.callParent()}});Ext.define("Bozuko.view.contest.edit.Form",{extend:"Ext.panel.Panel",alias:"widget.contestform",requires:["Bozuko.view.contest.edit.Details","Bozuko.view.contest.edit.Prizes","Bozuko.view.contest.edit.ConsolationPrizes","Bozuko.view.contest.edit.Game","Bozuko.view.contest.edit.Entry","Bozuko.view.contest.edit.Rules","Bozuko.view.contest.edit.Preview"],layout:"border",border:false,initComponent:function(){var a=this;a.tbar=Ext.create("Ext.toolbar.Toolbar",{ref:"contestform-navbar",cls:"title-toolbar",defaults:{xtype:"button",scale:"medium",iconAlign:"left"},items:[{text:"Back",action:"back",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-circle-direction-left-24.png"}," ",{xtype:"tbtext",ref:"edit-label-text",text:"Edit Campaign:"},{xtype:"tbtext",ref:"edit-campaign-text",text:""}]});a.items=[{region:"center",border:false,layout:"card",activeItem:0,defaults:{bodyPadding:15,border:false},items:[{xtype:"contestformdetails",ref:"contest"},{xtype:"contestformprizes",ref:"prizes"},{xtype:"contestformconsolationprizes",ref:"consolation_prizes"},{xtype:"contestformgame",ref:"game"},{xtype:"contestformentry",ref:"entry"},{xtype:"contestformrules",ref:"rules"}]},{region:"west",border:false,width:160,items:[{xtype:"dataview",cls:"campaign-nav",itemSelector:".nav-item",trackOver:true,overItemCls:"nav-item-over",selectedItemCls:"nav-item-selected",allowDeselect:false,onContainerClick:function(){return false},store:new Ext.data.Store({fields:["type","text"],data:[{type:"contest",text:"Campaign Details"},{type:"prizes",text:"Prizes"},{type:"consolation_prizes",text:"Consolation Prizes"},{type:"game",text:"Game"},{type:"entry",text:"Entries"},{type:"rules",text:"Rules"},],autoLoad:true}),tpl:new Ext.XTemplate('<ul class="campaignform-nav">','<tpl for=".">','<li class="nav-item {type}">',"{text}","</li>","</tpl>","</ul>"),listeners:{render:function(){Ext.Function.defer(this.select,10,this,[0])}}}]},{region:"east",width:200,xtype:"contestformpreview"}];a.bbar=["->",{scale:"medium",type:"button",action:"save",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-circle-check-24.png",autoWidth:true,text:"Save"}];a.callParent()},setRecord:function(a){this.record=a;this.down("[ref=prizes]").bindStore(a.prizes());var c=this.record.get("consolation_config");this.down("[ref=consolation_prizes]").getForm().setValues(c&&c.length?c[0]:{});this.down("[ref=consolation_prizes]").bindStore(a.consolation_prizes());this.down("contestformdetails").getForm().loadRecord(this.record);this.down("contestformgame").getForm().loadRecord(this.record);this.down("contestformrules").getForm().loadRecord(this.record);var b=this.record.get("entry_config");this.down("contestformentry").setValues(b&&b.length?b[0]:{});this.down("[ref=edit-campaign-text]").setText(a.get("name"));if(!a.get("_id")){this.down("[ref=edit-label-text]").setText("Create Campaign")}}});Ext.define("Bozuko.view.contest.builder.card.General",{extend:"Bozuko.view.contest.builder.Card",alias:"widget.contestbuildergeneral",requires:["Bozuko.view.contest.builder.Card","Ext.ux.form.field.DateTime"],name:"Basic Information",overview:["<p>It is easy to create a new Bozuko campaign. We will help describe each ","step as you are filling out the form.</p>"],intro:["Please enter the basic information about your campaign below."],initComponent:function(){var a=this;Ext.apply(a.form,{items:[{name:"name",fieldLabel:"Campaign Name",emptyText:"Your Campaign Name",allowBlank:false,helpText:["<p>","Enter a reference name for this campaign.  This name will not be publicly visible.","</p>","<p>",'Example: "Summer Scratch #2"',"</p>"]},{xtype:"container",border:false,arrowCt:true,style:"position: relative; overflow: visible",layout:{type:"hbox"},items:[{labelAlign:"top",xtype:"fieldcontainer",border:false,fieldLabel:"Start",layout:"hbox",flex:1,autoHeight:true,fieldLabel:"Start Date",helpText:["<p>","This is the date and time your game will be available to players in the mobile application.","</p>"],items:[{xtype:"datefield",name:"start",allowBlank:false,format:"m-d-Y",fieldLabel:"Start Date",hideLabel:true,autoHeight:true,flex:1,emptyText:"Start Date of the Campaign",listeners:{scope:a,focus:function(b){if(!b.isExpanded){b.onTriggerClick()}},select:a.onStartChange}},{xtype:"splitter"},{xtype:"timefield",name:"start_time",value:new Date(2011,1,1,12),editable:false,allowBlank:false,hideLabel:true,autoHeight:true,flex:1,increment:60}]},{xtype:"splitter",width:20},{labelAlign:"top",xtype:"fieldcontainer",border:false,fieldLabel:"Cutoff Date",layout:"hbox",flex:1,autoHeight:true,helpText:["<p>","This is the cut-off date for your campaign. Your campaign ends when total entries are exhausted or this date hits.","</p>"],items:[{flex:1,xtype:"datefield",name:"end",allowBlank:false,format:"m-d-Y",fieldLabel:"Cut Off Date",hideLabel:true,autoHeight:true,listeners:{scope:a,focus:function(b){if(!b.isExpanded){b.onTriggerClick()}},select:a.onEndChange}},{xtype:"splitter"},{xtype:"timefield",name:"end_time",value:new Date(2011,1,1,12),editable:false,allowBlank:false,hideLabel:true,autoHeight:true,flex:1,increment:60}]}]}]});a.callParent(arguments);a.on("render",a.onStartChange,a);a.on("render",a.onEndChange,a)},onStartChange:function(b){var a=this;a.down("datefield[name=end]").setMinValue(a.down("datefield[name=start]").getValue())},onEndChange:function(b){var a=this;a.down("datefield[name=start]").setMaxValue(a.down("datefield[name=end]").getValue())},loadContest:function(){var a=this;a.callParent(arguments);a.down("[name=start_time]").setValue(a.contest.get("start"));a.down("[name=end_time]").setValue(a.contest.get("end"))},validate:function(){var b=this;var a=b.callParent();if(!a){return false}if(b.contest.get("start")>b.contest.get("end")){return"The start date must be later than the end date"}return a},updateRecord:function(){var c=this;c.callParent(arguments);var b=c.down("[name=start_time]").getValue(),a=c.down("[name=end_time]").getValue();c.contest.get("start").setHours(b.getHours());c.contest.get("start").setMinutes(b.getMinutes());c.contest.get("start").setSeconds(b.getSeconds());c.contest.get("end").setHours(a.getHours());c.contest.get("end").setMinutes(a.getMinutes());c.contest.get("end").setSeconds(a.getSeconds())}});Ext.define("Bozuko.view.contest.builder.card.prize.Form",{extend:"Ext.form.Panel",alias:"widget.contestbuilderprizeform",cls:"builder-prize-form",bodyCls:"builder-prize-form-body",requires:["Bozuko.lib.form.field.Duration","Bozuko.lib.form.field.Codes"],barcodeRegex:{ean:/^([0-9]{8}|[0-9]{13})$/,upc:/^[0-9]{11,12}$/,isbn:/.*/,"39":/^[0-9a-zA-Z\-\.\s\$\/\+\%]+$/,"93":/^[0-9a-zA-Z\-\.\s\$\/\+\%!"§&]+$/,"128c":/.*/,"128b":/.*/,"128":/.*/,i25:/.*/,cbr:/.*/,msi:/.*/,pls:/.*/},initComponent:function(){var b=this;Ext.apply(b,{layout:"anchor",style:"clear:both",defaults:{anchor:"0"},items:[{xtype:"container",ref:"the-summary",border:false,layout:"hbox",hidden:b.mode!="summary",items:[{flex:1,xtype:"component",ref:"summary-tpl",tpl:new Ext.XTemplate('<tpl if="name">','<div style="padding-top: 2px;"><table style="width:100%; line-height: 20px;"><tr valign="top">',"<td>{name}</td>",'<td width="5%" style="padding-right:12px;">','<table style="font-size: 11px;">','<tr valign="top">','<td><div style="text-align: right; white-space:nowrap; color: #666; padding-right: 6px;">',"Total Quantity:","</div></td>",'<td><div style="white-space:nowrap; text-align: left; ">',"{total}","</div></td>","</tr>",'<tr valign="top">','<td><div style="text-align: right; white-space:nowrap; color: #666; padding-right: 6px;">',"Total Value:","</div></td>",'<td><div style="white-space:nowrap; text-align:left;">',"${[(values.value*values.total).toFixed(2)]}","</div></td>","</tr>","</table>","</td>","</tr></table></div>","</tpl>"),data:b.prize.data},{xtype:"splitter"},{xtype:"button",text:"Edit",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/page-pencil-16.png",handler:b.switchMode,scope:b},{xtype:"splitter"},{xtype:"button",text:"Delete",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-circle-minus-16.png",handler:function(){b.fireEvent("deleteme",b,b.prize)}}]},{xtype:"container",ref:"the-form",hidden:b.mode=="summary",border:false,layout:"anchor",defaults:{xtype:"textfield",labelWidth:120,anchor:"0"},autoHeight:true,items:[{xtype:"container",arrowCt:true,layout:"hbox",border:false,autoHeight:true,defaults:{autoHeight:true,labelAlign:"left",xtype:"textfield"},items:[{name:"name",fieldLabel:"Prize Name",flex:1,labelWidth:120,emptyText:"Enter the prize name",allowBlank:false,helpText:["<p>","Enter the prize name. Please try to keep it as short as possible.","</p>"]},{xtype:"splitter"},{name:"value",fieldLabel:"Value",labelWidth:36,width:80,emptyText:"USD",allowBlank:false,helpText:["<p>","Enter the value per prize for tracking purposes.","</p>"]},{xtype:"splitter"},{name:"total",fieldLabel:"Quantity",labelWidth:52,width:94,regex:/^[0-9]+$/,maskRe:/[0-9]/,emptyText:"",allowBlank:false,helpText:["<p>","Enter the total quantity of this prize.","</p>"]}]},{xtype:"textarea",name:"description",fieldLabel:"Prize Description",emptyText:"Enter the complete prize description",helpText:["<p>","This will be the full prize description that the user can see. You can add any ","stipulations or restrictions here.","</p>"]},{xtype:"duration",name:"duration",fieldLabel:"Redemption Period",emptyText:"Length of redemption period",allowBlank:false,helpText:["<p>","Enter the amount of time a player will have to redeem their prize from the time they win.","</p>"]},{xtype:"combo",name:"redemption_type",fieldLabel:"Redemption Method",emptyText:"Please choose the redemption method",editable:false,forceSelection:true,displayField:"display",valueField:"value",queryMode:"local",allowBlank:false,store:Ext.create("Ext.data.Store",{fields:["value","display"],data:[{value:"image",display:"In Person / Security Image"},{value:"barcode",display:"Barcode"},{value:"email",display:"Email"}]}),helpText:["<p>","Describe each method here.","</p>"],listeners:{scope:b,change:b.onRedemptionTypeChange}},{xtype:"container",layout:"anchor",autoHeight:true,border:false,ref:"redemption_fields",defaults:{anchor:"0",labelWidth:120,autoHeight:true,labelAlign:"left",xtype:"textfield"}},{xtype:"container",layout:"hbox",border:false,items:[{xtype:"splitter",flex:1},{xtype:"button",scale:"medium",text:"Cancel",hidden:true,ref:"cancel-btn",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-circle-direction-up-24.png",handler:function(){b.getForm().setValues(b._original_values);b.updateRecord();b.switchMode()}},{xtype:"splitter"},{xtype:"button",scale:"medium",text:"Delete",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-circle-minus-24.png",handler:function(){b.fireEvent("deleteme",b,b.prize)}},{xtype:"splitter"},{xtype:"button",scale:"medium",text:"Save",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-circle-check-24.png",handler:b.save,scope:b}]}]}]});b._original_values=Ext.Object.merge({},b.prize.data);b.callParent(arguments);var a=function(){b.down("[ref=summary-tpl]").update(b.prize.data)};b.prize.on("modify",a);b.on("destroy",function(){b.prize.un("modify",a)});b.redemption_fields={common:[{xtype:"textarea",height:36,name:"instructions",fieldLabel:"Instructions",emptyText:"Describe how a user will redeem this prize",allowBlank:false,helpText:["<p>","Describe what the user needs to do to redeem this prize. For example, ",'"Show this screen to an employee."',"</p>"]}],image:[],barcode:[{xtype:"combo",name:"barcode_type",fieldLabel:"Barcode Format",emptyText:"What is the barcode format",allowBlank:false,editable:false,forceSelection:true,displayField:"display",valueField:"value",queryMode:"local",allowBlank:false,store:Ext.create("Ext.data.Store",{fields:["value","display"],data:[{value:"ean",display:"EAN-8, EAN-13"},{value:"upc",display:"UPC"},{value:"isbn",display:"ISBN"},{value:"39",display:"Code 39"},{value:"93",display:"Code 93"},{value:"128c",display:"Code 128 C"},{value:"128b",display:"Code 128 B"},{value:"128",display:"Code 128"},{value:"i25",display:"Interleaved 2 of 5"},{value:"cbr",display:"Codabar"},{value:"msi",display:"MSI"},{value:"pls",display:"Plessey"}]}),helpText:["<p>","Please choose the format for your barcodes.","</p>"]},{xtype:"codes",name:"barcodes",fieldLabel:"Barcodes",emptyText:"Please enter the barcodes (one per line)",allowBlank:false,height:100,helpText:["<p>","Enter the text values for your barcodes. You should have one barcode per line.","</p>"]}],email:[{name:"email_subject",fieldLabel:"Email Subject",emptyText:"Subject of your email",allowBlank:false,helpText:["<p>","Please enter the subject of your email. The text will be processed before sending and the ","following replacements will be made:","</p>",'<table class="prize-help-table">',"<tr><th>{code}</th><td>The code</td></tr>","<tr><th>{prize}</th><td>The prize name.</td></tr>","<tr><th>{name}</th><td>The user's name.</td></tr>","<tr><th>{email}</th><td>The users email.</td></tr>","</table>"]},{xtype:"htmleditor",name:"email_body",fieldLabel:"Email Body",height:300,labelAlign:"top",allowBlank:false,helpText:["<p>","Please enter the body of your email. The text will be processed before sending and the ","following replacements will be made:","</p>",'<table class="prize-help-table">',"<tr><th>{code}</th><td>The code</td></tr>","<tr><th>{prize}</th><td>The prize name.</td></tr>","<tr><th>{name}</th><td>The user's name.</td></tr>","<tr><th>{email}</th><td>The users email.</td></tr>","</table>"]},{xtype:"codes",name:"email_codes",fieldLabel:"Email Codes",height:100,emptyText:"Please enter the email codes (one per line)",allowBlank:false,helpText:["<p>","Enter each all the individual email codes. Each code should be on its own line.","</p>"]}]};if(b.prize){b.loadForm(b.prize)}if(b.prize.get("name")){b.down("[ref=cancel-btn]").show()}b.on("render",function(){b.body.addCls("mode-"+b.mode)});b.initFieldEvents()},switchMode:function(){var a=this,b=a.mode=="summary"?"form":"summary";a.body.removeCls("mode-"+a.mode);a.mode=b;a.down("[ref=the-form]")[b=="summary"?"hide":"show"]();a.down("[ref=the-summary]")[b=="summary"?"show":"hide"]();if(a.mode=="form"){if(a.prize.get("name")){a.down("[ref=cancel-btn]").show()}a.focusFirstField()}a.fireEvent("sizechange");a.body.addCls("mode-"+a.mode)},focusFirstField:function(){this.down("field").focus()},initFieldEvents:function(a){var c=this;var b=Ext.Function.createBuffered(c.onChange,700,c);Ext.Array.each((a||c).query("field"),function(d){d.on("focus",function(){c.card.onFieldFocus(d)});d.on("blur",function(){c.card.onFieldBlur(d)});d.on("change",function(e){b(e)})});Ext.Array.each((a||c).query("htmleditor"),function(d){d.on("activate",function(e){c.card.onFieldFocus(e);e.clearInvalid();Ext.EventManager.on(e.getWin(),"focus",function(){c.card.onFieldFocus(e);e.clearInvalid()})})})},onRedemptionTypeChange:function(){var c=this,a=c.down("[ref=redemption_fields]"),b=c.down("[name=redemption_type]").getValue();a.removeAll();a.add(c.redemption_fields.common);if(c.redemption_fields[b]&&c.redemption_fields[b].length){a.add(c.redemption_fields[b])}Ext.Array.each(a.query("field,fieldcontainer,htmleditor"),function(d){if(c.prize.get(d.name)){d.setValue(c.prize.get(d.name))}});if(b!=c.prize.get("redemption_type")){c.down("[name=instructions]").setValue(c.prize.getDefaultInstructions(b));if(b=="email"){c.down("[name=email_subject]").setValue(c.prize.getDefaultEmailSubject());c.down("[name=email_body]").setValue(c.prize.getDefaultEmailBody())}}c.initFieldEvents(a);c.fireEvent("sizechange")},loadForm:function(e){var c=this;c.getForm().reset();Ext.Array.each(c.query("[redemption_field=yes]"),function(f){f.hide()});c.prize=e;if(e.get("name")){if(!e.get("redemption_type")){var b=e.get("email_codes"),d=e.get("barcodes");function a(f){var g=0;while(g<f.length){if(f[g]==""){f.splice(g,1)}else{g++}}}a(d);a(b);e.set("redemption_type",b&&b.length?"email":(d&&d.length?"barcode":"image"))}c.getForm().loadRecord(e)}},updateRecord:function(){var a=this;a.prize.set(a.getValues())},getValues:function(){var b=this,a={};Ext.each(b.query("field,htmleditor"),function(c){if(!c.up("duration")){a[c.name]=c.getValue()}});if(b.down("duration")){a.duration=b.down("duration").getValue()}return a},onChange:function(){this.updateRecord()},validate:function(){var d=this,e=d.getValues().redemption_type,g=d.getValues(),a=d.getForm().isValid();if(!a||e=="image"){return a}var b=e=="barcode"?g.barcodes:g.email_codes;if(b.length!=Number(g.total)){var c=e=="barcode"?"barcodes":"email_codes";d.down("[name="+c+"]").markInvalid("The number of codes does not match the quantity above.");return{title:"Quantity Mismatch",message:"The quantity specified does not match the number of codes"}}if(e=="email"){if(!~Ext.Array.indexOf(g.email_body,"{code}")){d.down("[name=email_body]").markInvalid();return{title:"Email Code",message:"The email body does not contain {code}. You must include this somewhere to be populated with the unique email codes."}}}if(e=="barcode"){var f=d.down("[name=barcode_type]").getValue(),h=d.barcodeRegex[f];var i=Ext.Array.each(b,function(j){return h.test(j)});if(Ext.isNumeric(i)){return{title:"Barcode Format Error",message:"One of the barcodes does not match the selected format."}}}return true},alert:function(c){var d,b,a="Uh-oh";if(Ext.isObject(c)){d=c.title||a;b=c.message}else{if(Ext.isString(c)){d=a;b=c}}if(!c){d=a;b="Please fix the errors on the form before moving on to the next step"}Ext.Msg.alert(d,b)},save:function(){var b=this,a=this.validate();if(a===true){this.prize.set(this.getValues());b.prize.set("is_email",b.prize.get("redemption_type")=="email");b.prize.set("is_barcode",b.prize.get("redemption_type")=="barcode");this.prize.commit();if(this.mode=="form"){this.switchMode()}return}b.alert(a);return}});Ext.define("Bozuko.view.contest.builder.card.Prizes",{extend:"Bozuko.view.contest.builder.Card",alias:"widget.contestbuilderprizes",requires:["Bozuko.view.contest.builder.card.prize.Form","Bozuko.model.Prize"],name:"Prizes",overview:["<p>Add your prizes</p>"],initComponent:function(){var a=this;a.prizes=a.contest.prizes();a.prizes.sort("value","DESC");Ext.apply(a.form,{items:[{ref:"add-container",xtype:"container",style:"text-align:center",items:[{xtype:"button",text:"Add a Prize",scale:"medium",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-circle-plus-24.png",handler:a.addPrize,scope:a}]}]});a.callParent(arguments);a.on("activate",a.onActivate,a);a.addContainer=a.down("[ref=add-container]")},onActivate:function(){var a=this;if(!a.prizes.getCount()){a.addPrize()}},addPrize:function(){var a=this;var b=new Bozuko.model.Prize({email_format:"text/html"});a.prizes.add(b);a.addPrizeForm(b).focusFirstField()},addPrizeForm:function(c,d){var b=this,a=b.form.items.indexOf(b.addContainer);return b.form.insert(a,{xtype:"contestbuilderprizeform",prize:c,card:b,mode:d||"form",listeners:{sizechange:b.onSizeChange,deleteme:b.deletePrize,scope:b}})},deletePrize:function(b,c){var a=this;Ext.Msg.confirm("Delete Prize","Are you sure you would like to delete this prize?",function(d){if(d!="yes"){return}a.form.remove(b);a.prizes.remove(c)})},onSizeChange:function(){var a=this;a.form.doLayout()},loadContest:function(){var a=this;if(!a.rendered){a.on("render",a.addPrizeForms,a)}else{a.addPrizeForms()}},addPrizeForms:function(){var a=this;a.prizes.each(function(b){a.addPrizeForm(b,"summary")})},updateRecord:function(){},focusFirstField:function(){return},validate:function(){var a=this,b=true;Ext.Array.each(a.query("contestbuilderprizeform"),function(c){b=c.validate();if(b===true){c.save()}return b===true});if(b!==true){return{title:"Prize Errors",message:"Please correct the errors noted on the form"}}return a.prizes.getCount()?true:{title:"No Prizes",message:"You must add at least one prize"}}});Ext.define("Bozuko.store.Winners",{extend:"Ext.data.Store",requires:["Bozuko.model.Winner","Bozuko.lib.PubSub","Ext.data.reader.Json"],model:"Bozuko.model.Winner",isListener:true,constructor:function(){var a=this;a.last={};a.listening=false;a.callParent(arguments);a.on("beforeload",a.onBeforeLoad,a);if(a.isListener){a.startListening();a.tmpStore=a.self.create({page_id:a.page_id,contest_id:a.contest_id,isListener:false,parent:a,autoLoad:false})}},onBeforeLoad:function(b,a){var c=this;if(!c.page_id&&!c.contest_id){return}if(!a.params){a.params={}}a.params.page_id=c.page_id;a.params.contest_id=c.contest_id},startListening:function(){var c=this,a={};if(c.listening&&c.last&&c.last.page_id==c.page_id&&c.last.contest_id==c.contest_id){return}if(c.page_id){a.page_id=c.page_id}if(c.contest_id){a.contest_id=c.contest_id}if(!c.page_id&&!c.contest_id){a=true}var b=function(d,e){c.updateStore();e()};Bozuko.PubSub.subscribe("prize/redeemed",a,b);Bozuko.PubSub.subscribe("contest/win",a,b);Bozuko.PubSub.subscribe("contest/consolation",a,b);c.on("destroy",function(){Bozuko.PubSub.unsubscribe("prize/redeemed",a,b);Bozuko.PubSub.unsubscribe("contest/win",a,b);Bozuko.PubSub.unsubscribe("contest/consolation",a,b)});c.listening=true},updateStore:function(a){var b=this;if(b._isLoading){b._loadAgain=true;b._loadAgainCallback=a;return}b._isLoading=true;b.tmpStore.load({scope:b,callback:function(c){b._isLoading=false;if(b._loadAgain){b._loadAgain=false;b.updateStore(b._loadAgainCallback)}var d=0;if(a){a()}Ext.Array.each(c,function(e,g){var h=b.getById(e.getId());if(h){var f=b.indexOf(h);if(f!==g){b.removeAt(f);b.insert(g,h)}h.set(e.data);h.commit()}else{b.insert(d++,e)}});while(b.getCount()>100){b.removeAt(100)}}})}});Ext.define("Bozuko.view.contest.Winners",{extend:"Ext.panel.Panel",alias:"widget.contestwinners",requires:["Bozuko.store.Winners"],blinkTime:1000*60*1,blinkRate:800,blinkCls:"winner-blink",showNotifications:function(){},initComponent:function(){var a=this;a.blinkState=false;a.blinkers=[];a.blinking=false;a.layout="fit";a.store=Ext.create("Bozuko.store.Winners",{autoLoad:true,contest_id:a.contest_id||(a.contest?a.contest.get("_id"):null),page_id:a.page_id||(a.page?a.page.get("_id"):null)});a.bufferedSearch=Ext.Function.createBuffered(function(){a.store.load()},250);a.store.on("beforeload",a.onBeforeLoad,a);a.store.on("load",a.onStoreLoad,a);a.dockedItems=[{xtype:"toolbar",dock:"top",items:[{xtype:"textfield",emptyText:"Search...",inputType:"search",ref:"search",enableKeyEvents:true,listeners:{change:a.bufferedSearch}}]},{xtype:"pagingtoolbar",dock:"bottom",displayMsg:"{0} - {1} of {2}",store:a.store,displayInfo:true}];a.items=[{xtype:"dataview",cls:"bozuko-list winners-list",trackOver:true,overItemCls:"x-item-over",autoScroll:true,deferEmptyText:false,emptyText:'<div style="padding: 10px;">No Winners yet!</div>',store:a.store,itemTpl:new Ext.XTemplate('<div class="prize-{prize.state}">','<tpl if="!this.isContestSpecific()">','<div class="contest-name">','<tpl if="this.showPageTitle()">',"<strong>{page.name}</strong> - ","</tpl>","{contest.name}","</div>","</tpl>",'<div class="winner-body">','<img src="{[this.getImage(values.user.image)]}" />','<div class="user-name">{[this.getUserName(values)]}</div>','<div class="user-friend-count">{[this.getFriendCount(values)]} Friends</div>','<div class="prize-name">{prize.name}</div>','<div class="prize-code">{prize.code}</div>','<tpl if="prize.redeemed">','<div class="prize-timestamp">','<span class="label">Redeemed:</span> {[this.getFormattedDate(values.prize.redeemed_time)]}',"</div>","</tpl>",'<div class="prize-timestamp"><span class="label">Won:</span>{[this.getFormattedDate(values.prize.timestamp)]}</div>',"</div>","</div>",{isPageSpecific:function(){return !!a.store.page_id},isContestSpecific:function(){return !!a.store.contest_id},getImage:function(b){if(/facebook\.com/.test(b)){b=b.replace(/type=large/,"type=square")}return b},getFriendCount:function(b){try{return b.user.friend_count}catch(c){return 0}},getFormattedDate:function(c){var b=Ext.Date.parse(c,"c");return Ext.Date.format(b,"m/d/Y h:i a")},showPageTitle:function(){return !this.isPageSpecific()},getUserName:function(b){var c=b.user.name;if(b.user.facebook_link){c='<a href="'+b.user.facebook_link+'" target="_blank">'+c+"</a>"}return c}}),listeners:{scope:a,refresh:a.onRefresh,itemadd:a.refresh,itemupdate:a.refresh,itemremove:a.refresh},onDestroy:function(){if(this.loadMask===true){this.loadMask=false}this.callParent(arguments)}}];a.callParent(arguments)},onBeforeLoad:function(b,a){var e=this,d=this.down("[ref=search]"),c=d.getValue();e.store.getProxy().extraParams.search=c;if(e.searchTerm!=c){a.start=0;a.page=1;b.currentPage=1}e.searchTerm=c},onStoreLoad:function(){var a=this;try{a.down("dataview").getEl().dom.scrollTop=0}catch(b){}},refresh:function(){this.down("dataview").refresh()},onRefresh:function(){var c=this,a=c.down("dataview"),b=[];c.store.each(function(e,g){var d=false,f=new Date();switch(e.get("prize").state){case"redeemed":var i=new Date();i.setTime(Date.parse(e.get("prize").redeemed_time));var h=+f-i;if(h>c.blinkTime){break}d=true;break;default:break}if(!d){return}b.push({node:a.getNode(g),time:i,blinking:false})});c.blinkers=b;if(!c.blinking){c.blink()}},blink:function(){var d=this,b=new Date();clearTimeout(d.blinkTimeout);if(!d.blinkers.length){return}d.blinkState=!d.blinkState;var a=[];while(d.blinkers.length){var f=d.blinkers.shift(),e=+b-f.time;f.blinking=e<d.blinkTime;var c=f.blinking&&d.blinkState?"addCls":"removeCls";Ext.fly(f.node)[c](d.blinkCls);if(f.blinking){a.push(f)}}d.blinkers=a;if(!d.blinkers.length){d.blinking=false;return}d.blinking=true;d.blinkTimeout=setTimeout(function(){d.blink()},d.blinkRate)},setContest:function(a){var b=this;b.contest=a;b.store.contest_id=a.get("_id");b.tmpStore.contest_id=a.get("_id");b.store.load()},setPage:function(b){var a=this;a.page=b;a.store.page_id=b.get("_id");a.tmpStore.page_id=b.get("_id");a.store.load()}});Ext.define("Bozuko.view.contest.Review",{extend:"Ext.panel.Panel",alias:"widget.contestreview",requires:["Bozuko.store.EntryTypes","Bozuko.store.Games"],durations:[{label:"Years",value:1000*60*60*24*365},{label:"Months",value:1000*60*60*24*30},{label:"Weeks",value:1000*60*60*24*7},{label:"Days",value:1000*60*60*24},{label:"Hours",value:1000*60*60},{label:"Minutes",value:1000*60},{label:"Seconds",value:1000}],initComponent:function(){var a=this;if(a.contest&&a.contest.get("active")){a.name="Review"}Ext.apply(a,{data:a.contest.data,tpl:new Ext.XTemplate('<div class="campaign-overview">','<div class="row big-row first-row">','<div class="label">Campaign:</div>','<div class="content">{name}</div>',"</div>",'<div class="row timeline">','<div class="label">Timeline:</div>','<div class="content">{[this.timeline()]}</div>',"</div>",'<div class="row entry">','<div class="label">Contest Odds:</div>','<div class="content">{[this.contestOdds()]}</div>',"</div>",'<div class="row entry">','<div class="label">Entry Method:</div>','<div class="content">{[this.entryMethod()]}</div>',"</div>",'<div class="row game">','<div class="label">Game:</div>','<div class="content">{[this.game()]}</div>',"</div>",'<div class="row game-name">','<div class="label">Game Name:</div>','<div class="content">{[this.gameName()]}</div>',"</div>","{[this.gameOptions()]}",'<div class="row prizes">','<div class="label">Prizes:</div>','<div class="content">{[this.prizes()]}</div>',"</div>","</div>",{timeline:function(){var b="D M d, Y h:i A";return Ext.Date.format(a.contest.get("start"),b)+" &mdash; "+Ext.Date.format(a.contest.get("end"),b)},entryMethod:function(){var b=Ext.data.StoreManager.lookup("entry-types").findRecord("type",a.contest.getEntryConfig().type).get("img");return['<img src="',b,'" height="50" style="float: right; margin: 0 0 0 6px;" />',a.contest.getEntryType(false),"<br />","Users can play every ",a.getFormattedDuration(a.contest.getEntryConfig().duration)].join("")},game:function(){var b=Ext.data.StoreManager.lookup("games").findRecord("game",a.contest.get("game")).get("img");var c=['<img src="',b,'" height="50" style="float: right; margin: 0 0 0 6px;" />',a.contest.getGameName(),"<br />",a.contest.getEntryConfig().tokens+" plays per Entry"];return c.join("")},gameName:function(){var b=a.contest.get("game_config");return b.name||(a.contest.get("game")=="slots"?"Slots":"Scratch")},gameOptions:function(){var b=a.contest.get("game_config"),d=a.contest.get("game");if(b.theme){var e=b.theme.substr(0,1).toUpperCase()+b.theme.substr(1),c=Bozuko.Router.route("/themes/"+d+"/"+b.theme+"/image");return['<div class="row game-theme">','<div class="label">Game Theme:</div>','<div class="content">',(c?'<img src="'+c+'" height="50" style="float:right;" />':""),e,"</div>","</div>"].join("")}return""},prizes:function(){var c=["prizes-container"];if(a.prizes_expanded){c.push("expanded")}var b=['<div class="prizes-overview">','<div class="expander"></div>',"<strong>",a.contest.prizes().count(),"</strong> Prize Types<br />","<strong>",a.contest.getTotalPrizeCount(),"</strong> Total Prizes<br />","<strong>$",a.contest.getTotalPrizesValue().toFixed(2),"</strong>"," Total Value","</div>"];b.push('<div class="prizes-list">');a.contest.prizes().each(function(f,e){var g=(function(){switch(f.get("redemption_type")){case"image":return"Security Image";case"barcode":return"Barcode";case"email":return"Email"}return"Unknown"})();var d=["prize"];if(e==a.contest.prizes().getCount()-1){d.push("last-prize")}b=b.concat(['<div class="',d.join(" "),'">','<div class="prize-odds">',"Odds: ",a.contest.getPrizeOdds(e),"</div>",'<div class="prize-name">',f.get("name"),"</div>",'<div class="prize-details">','<div class="prize-redemption">','<span class="plabel">Redemption Type:</span><span class="val">',g,"</span>","</div>",'<div class="prize-value">','<span class="plabel">Value:</span><span class="val">$',f.get("value"),"</span>","</div>",'<div class="prize-quantity">','<span class="plabel">Quantity:</span><span class="val">',f.get("total"),"</span>","</div>","</div>","</div>"])});b.push("</div>");return['<div class="',c.join(" "),'">'].concat(b).concat(["</div>"]).join("")},contestOdds:function(){return["1 in "+a.contest.get("win_frequency").toFixed(1)+" entries will win","<br />",a.contest.get("total_entries")+" Total Entries"].join("")}})});a.callParent();a.on("render",a.refresh,a)},getFormattedDuration:function(b){var g,a;for(var e=0;e<this.durations.length;e++){if(b>=this.durations[e].value){var f=this.durations[e].value;g=b/f,u=f,a=this.durations[e].label;if(Math.round(g)!=g&&!this.isTwoDecimalPlacesOrLess(g)){for(var c=e;c<this.durations.length;c++){f=this.durations[c].value;var h=b/f;if(Math.round(h)==h||this.isTwoDecimalPlacesOrLess(h)){g=h,u=f,a=this.durations[c].label;break}}}break}}if(g===1){g="";a=a.replace(/s$/,"")}return g+" "+((a||"seconds").toLowerCase())},isTwoDecimalPlacesOrLess:function(b){var a=new String(b);if(!~a.indexOf(".")){return true}return a.split(".")[1].length<3},refresh:function(){var a=this;if(!a.rendered){return}if(!a.contest){return}a.update(a.contest.data);setTimeout(function(){var b=a.getEl().down(".prizes .expander");if(b){b.on("click",function(f,d){var c=Ext.fly(d).up(".prizes-container");c.toggleCls("expanded");a.prizes_expanded=c.hasCls("expanded")})}},300)}});Ext.define("Bozuko.view.contest.builder.card.Review",{extend:"Bozuko.view.contest.builder.Card",alias:"widget.contestbuilderreview",requires:["Bozuko.view.contest.builder.Card","Bozuko.view.contest.Review",],name:"Review and Publish",overview:"Please review your campaign to make sure everything is entered correctly.",initComponent:function(){var a=this;if(a.contest&&a.contest.get("active")){a.name="Review"}Ext.apply(a.form,{xtype:"contestreview",contest:a.contest});a.callParent();a.on("activate",a.refresh,a)},refresh:function(){var a=this;a.form.refresh()},loadContest:function(){},updateRecord:function(){},validate:function(){return true}});Ext.define("Bozuko.view.contest.builder.Panel",{extend:"Ext.panel.Panel",alias:"widget.contestbuilder",cls:"contest-builder",requires:["Bozuko.model.Contest","Bozuko.view.contest.builder.Preview","Bozuko.view.contest.builder.card.General","Bozuko.view.contest.builder.card.Entry","Bozuko.view.contest.builder.card.Game","Bozuko.view.contest.builder.card.Prizes","Bozuko.view.contest.builder.card.Odds","Bozuko.view.contest.builder.card.Review"],initComponent:function(){var a=this;if(!a.contest){a.contest=new Bozuko.model.Contest({name:"",engine_type:"order",engine_mode:"odds",auto_rules:true,free_play_pct:20,consolation_config:{},consolation_prizes:[],post_to_wall:true})}a.dockedItems=[{xtype:"toolbar",dock:"top",ref:"contestform-navbar",cls:"title-toolbar",defaults:{xtype:"button",scale:"medium",iconAlign:"left"},items:[{text:"Back",action:"back",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-circle-direction-left-24.png"}," ",{xtype:"tbtext",ref:"edit-campaign-text",text:a.contest.get("name")||"Build a Campaign"},"->"]}];Ext.apply(a,{layout:"border",defaults:{border:false},items:[{region:"center",layout:"card",activeItem:0,defaults:{border:false,contest:a.contest},items:[{xtype:"contestbuildergeneral"},{xtype:"contestbuilderentry"},{xtype:"contestbuildergame"},{xtype:"contestbuilderprizes"},{xtype:"contestbuilderodds"},{xtype:"contestbuilderreview"}]},{xtype:"contestbuilderpreview",width:230,region:"east",contest:a.contest,builder:a}]});a.callParent(arguments);a.preview=a.down("contestbuilderpreview");a.stepToolbar=a.down("toolbar[ref=contestform-navbar]");a.centerPanel=a.down("[region=center]");a.centerPanel.items.each(function(c,d){if(c.addNavigationButtons){var e=[];if(d>0){e.push("back")}if(d!==a.centerPanel.items.getCount()-1){if(a.contest.get("_id")){e.push("apply");e.push("save");if(!a.contest.get("active")){}}e.push("next")}else{if(a.contest.get("active")){e.push("apply");e.push("save")}else{e.push("save-draft");e.push("publish")}}c.addNavigationButtons(e)}var b=!a.contest.get("_id");a.stepToolbar.add({ref:"step-btn",text:(d+1)+". "+c.name,disabled:b?d!==0:false,toggled:d===0,handler:function(){a.goToCard(d)}});c.on("activate",a.onCardActivate,a);c.on("back",a.back,a);c.on("next",a.next,a);c.on("finish",a.finish,a);c.on("save",a.save,a);c.on("apply",a.apply,a);c.on("publish",a.publish,a)});a.stepButtons=a.stepToolbar.query("button[ref=step-btn]");a.stepToolbar.add(" ")},onCardActivate:function(b){var c=this,a=c.centerPanel.items.indexOf(b);Ext.Array.each(c.stepButtons,function(e,d){if(d<=a){e.setDisabled(false)}e.toggle(d===a)})},currentStep:function(){var a=this;return a.centerPanel.items.indexOf(a.activeCard())},activeCard:function(){var a=this;return a.centerPanel.getLayout().getActiveItem()},next:function(a){var b=this;b.goToCard(b.currentStep()+1)},back:function(a){var b=this;b.goToCard(b.currentStep()-1)},validate:function(){var b=this,a=true;b.centerPanel.items.each(function(d,e){a=d.validate();if(a!==true){b.goToCard(e);var g,f,c="Uh-oh";if(Ext.isObject(a)){g=a.title||c;f=a.message}else{if(Ext.isString(a)){g=c;f=a}}if(!a){g=c;f="Please fix the errors on the form before saving"}Ext.Msg.alert(g,f);return false}return true});return a===true},save:function(){if(this.validate()){this.fireEvent("save",this)}},apply:function(){if(this.validate()){this.fireEvent("apply",this)}},publish:function(){if(this.validate()){this.fireEvent("publish",this)}},goToCard:function(b){var e=this,d;if(e.currentStep()<b&&(d=e.activeCard().validate())!==true){var f,c,a="Uh-oh";if(Ext.isObject(d)){f=d.title||a;c=d.message}else{if(Ext.isString(d)){f=a;c=d}}if(!d){f=a;c="Please fix the errors on the form before moving on to the next step"}Ext.Msg.alert(f,c);return}e.centerPanel.getLayout().setActiveItem(b);e.preview.onContestModify()}});Ext.define("Bozuko.store.Entries",{extend:"Ext.data.Store",requires:["Bozuko.model.Entry","Bozuko.lib.PubSub","Ext.data.reader.Json"],model:"Bozuko.model.Entry",isListener:true,constructor:function(){var a=this;a.last={};a.listening=false;a.callParent(arguments);a.on("beforeload",a.onBeforeLoad,a);if(a.isListener){a.startListening();a.tmpStore=a.self.create({page_id:a.page_id,contest_id:a.contest_id,isListener:false,parent:a,autoLoad:false})}},onBeforeLoad:function(b,a){var c=this;if(!c.page_id&&!c.contest_id){return}if(!a.params){a.params={}}a.params.page_id=c.page_id;a.params.contest_id=c.contest_id},startListening:function(){var c=this,a={};if(c.listening&&c.last&&c.last.page_id==c.page_id&&c.last.contest_id==c.contest_id){return}if(c.page_id){a.page_id=c.page_id}if(c.contest_id){a.contest_id=c.contest_id}if(!c.page_id&&!c.contest_id){a=true}var b=function(d,e){c.updateStore();e()};Bozuko.PubSub.subscribe("contest/entry",a,b);c.on("destroy",function(){Bozuko.PubSub.unsubscribe("contest/entry",a,b)});c.listening=true},updateStore:function(b){var a=this;if(a._isLoading){a._loadAgain=true;a._loadAgainCallback=b;return}a._isLoading=true;a.tmpStore.load({scope:a,callback:function(c){a._isLoading=false;if(a._loadAgain){a._loadAgain=false;a.updateStore(a._loadAgainCallback)}var d=0;if(b){b()}Ext.Array.each(c,function(e,f){var g=a.getById(e.getId());if(g){g.set(e.data);g.commit()}else{a.insert(d++,e)}});while(a.getCount()>100){a.removeAt(100)}}})}});Ext.define("Bozuko.view.contest.Entries",{alias:"widget.contestentries",extend:"Ext.panel.Panel",requires:["Bozuko.model.User","Bozuko.store.Entries"],initComponent:function(){var a=this;a.store=Ext.create("Bozuko.store.Entries",{autoLoad:true,page_id:a.page_id||(a.page?a.page.get("_id"):null),contest_id:a.contest_id||(a.contest?a.contest.get("_id"):null)});a.bufferedSearch=Ext.Function.createBuffered(function(){a.store.load()},250);a.store.on("beforeload",a.onBeforeLoad,a);a.store.on("load",a.onStoreLoad,a);a.layout="fit";a.dockedItems=[{xtype:"toolbar",dock:"top",items:[{xtype:"textfield",inputType:"search",emptyText:"Search...",ref:"search",enableKeyEvents:true,listeners:{change:a.bufferedSearch}}]},{xtype:"pagingtoolbar",dock:"bottom",displayMsg:"{0} - {1} of {2}",store:a.store,displayInfo:true}];a.items=[{xtype:"dataview",cls:"bozuko-list entry-list",deferEmptyText:false,emptyText:'<div style="padding: 10px;">No Players yet!</div>',autoScroll:true,trackOver:true,overItemCls:"entry-item-over",store:a.store,itemTpl:new Ext.XTemplate('<div class="entry-item">','<tpl if="!this.isContestSpecific()">','<div class="contest-name">','<tpl if="this.showPageTitle()">',"<strong>{page.name}</strong> - ","</tpl>","{contest.name}","</div>","</tpl>",'<div class="entry-body">','<img src="{[this.getImage(values.user.image)]}" />','<div class="user-name">{[this.getUserName(values)]}</div>','<div class="user-friend-count">{[this.getFriendCount(values)]} Friends</div>','<div class="entry-type">{[this.getEntryType(xindex)]}</div>','<div class="entry-timestamp">{[this.getFormattedDate(values.timestamp)]}</div>',"</div>","</div>",{isPageSpecific:function(){return !!a.store.page_id},isContestSpecific:function(){return !!a.store.contest_id},getEntryType:function(b){return a.store.getAt(b-1).getEntryType()},getFriendCount:function(b){try{return b.user.friend_count}catch(c){return 0}},getImage:function(b){if(/facebook\.com/.test(b)){b=b.replace(/type=large/,"type=square")}return b},getFormattedDate:function(c){var b=new Date();b.setTime(Date.parse(c));return Ext.Date.format(b,"m/d/Y h:i a")},showPageTitle:function(){return !this.isContestSpecific()&&!this.isPageSpecific()},getUserName:function(b){var c=b.user.name;if(b.user.facebook_link){c='<a href="'+b.user.facebook_link+'" target="_blank">'+c+"</a>"}return c}}),onDestroy:function(){if(this.loadMask===true){this.loadMask=false}this.callParent(arguments)}}];a.callParent(arguments)},onBeforeLoad:function(b,a){var f=this,e=this.down("[ref=search]"),d=e.getValue(),c=f.store.getProxy();f.store.getProxy().extraParams.search=d;if(f.searchTerm!=d){a.start=0;a.page=1;b.currentPage=1}f.searchTerm=d},onStoreLoad:function(){var a=this;try{a.down("dataview").getEl().dom.scrollTop=0}catch(b){}}});Ext.define("Bozuko.view.contest.Players",{alias:"widget.contestplayers",extend:"Ext.tab.Panel",requires:["Bozuko.model.User","Bozuko.view.contest.Winners","Bozuko.view.contest.Entries"],initComponent:function(){var a=this;Ext.apply(a,{activeItem:0,items:[{title:"Winners",xtype:"contestwinners",contest_id:a.contest_id,page_id:a.page_id},{xtype:"contestentries",title:"Entries",contest_id:a.contest_id,page_id:a.page_id}]});a.callParent(arguments)}});Ext.define("Bozuko.view.page.Dashboard",{alias:"widget.pagedashboard",extend:"Ext.panel.Panel",requires:["Bozuko.view.contest.Players","Bozuko.lib.PubSub","Bozuko.view.chart.Basic"],initComponent:function(){var a=this;Ext.apply(a,{layout:"border",items:[{region:"east",style:"border-left: 1px solid #ccc;",xtype:"contestplayers",page_id:a.page.get("_id"),width:320,border:false},{region:"center",border:false,autoScroll:true,layout:"anchor",bodyPadding:10,items:[{xtype:"form",border:false,anchor:"0",defaults:{border:false,anchor:"0",labelAlign:"left"},items:[{ref:"statusField",xtype:"textarea",name:"status",fieldLabel:"Announcement"}],buttons:[{ref:"updateStatus",text:"Update"}]},{xtype:"component",autoEl:{tag:"h4",cls:"stats-heading",html:"Your Stats at a Glance"}},{xtype:"bozukochartbasic",anchor:"0",border:false,page_id:a.page.get("_id")}]}]});a.callParent(arguments)}});Ext.define("Bozuko.view.page.Panel",{extend:"Ext.panel.Panel",alias:"widget.pagepanel",requires:["Bozuko.view.page.Dashboard","Bozuko.view.contests.Panel","Bozuko.view.page.Settings","Bozuko.view.page.Resources","Bozuko.view.page.Account","Bozuko.store.Contests"],cls:"beta-panel",initComponent:function(){var a=this;Ext.apply(a,{height:400,layout:"border",border:false,items:[{region:"north",border:false,xtype:"toolbar",ref:"navigation",style:"border-width: 0px; border-bottom-width: 1px; padding: 4px;",bodyPadding:4,defaults:{xtype:"button",scale:"medium",cls:"x-btn-text-icon",iconAlign:"left"},items:[{page:"dashboard",text:"Dashboard",group:"page",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/page-24.png"},{page:"campaigns",text:"Campaigns",group:"page",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/dice-white-24.png"},{text:"Settings",page:"settings",group:"page",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/settings-24.png"},{text:"Resources",page:"resources",group:"page",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/page-forum-24.png"},{text:"Account",page:"account",group:"page",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/person-profile-24.png"},"->",{ref:"status-text",xtype:"tbtext",text:" "}]},{region:"center",layout:"card",ref:"pages",border:false,activeItem:0,items:[{ref:"dashboard",xtype:"pagedashboard",border:false,page:a.page},{ref:"campaigns",xtype:"contestspanel",border:false,store:Ext.create("Bozuko.store.Contests",{page_id:a.page.get("_id"),autoLoad:true})},{ref:"settings",xtype:"pagesettings",border:false,record:a.page},{ref:"resources",xtype:"pageresources",border:false,page:a.page},{ref:"account",xtype:"pageaccount",border:false,page:a.page}]}]});a.callParent(arguments);a.statusText=a.down("[ref=navigation] [ref=status-text]");a.on("destroy",function(){clearTimeout(a.statusTextTimeout)})},updateStatus:function(b){var a=this;clearTimeout(a.statusTextTimeout);a.statusText.setText(b);a.statusTextTimeout=setTimeout(function(){a.statusText.setText("")},3000)},successStatus:function(a){this.updateStatus('<div style="color: #999; line-height: 20px;">'+a+'<img style="margin: 0 0 0 4px; vertical-align:middle;" width="16" height="16" src="/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-square-check-16.png" /></div>')},failureStatus:function(a){this.updateStatus('<div style="color: #999; line-height: 20px;">'+a+'<img style="margin: 0 0 0 4px; vertical-align:middle;" width="16" height="16" src="/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-square-cross-16.png" /></div>')}});Ext.define("Bozuko.view.contest.Reports",{alias:"widget.contestreports",extend:"Ext.panel.Panel",requires:["Bozuko.view.contest.Overview","Bozuko.view.contest.Prizes","Bozuko.view.chart.Basic","Bozuko.view.contest.Players"],initComponent:function(){var a=this;a.tbar=Ext.create("Ext.toolbar.Toolbar",{ref:"contestform-navbar",cls:"title-toolbar",defaults:{xtype:"button",scale:"medium",iconAlign:"left"},items:[{text:"Back",action:"back",icon:"/images/icons/SweetiePlus-v2-SublinkInteractive/with-shadows/badge-circle-direction-left-24.png"}," ",{xtype:"tbtext",ref:"details-label-text",text:"Campaign Details:"},{xtype:"tbtext",ref:"details-campaign-text",text:a.record.get("name")||"Untitled Campaign"}]});Ext.apply(a,{layout:"border",items:[{record:a.record,xtype:"contestoverview",region:"north",border:false},{region:"center",xtype:"tabpanel",border:false,activeTab:0,defaults:{border:false},items:[{xtype:"bozukochartbasic",title:"Performance",contest_id:a.record.get("_id"),bodyPadding:10,autoScroll:true},{title:"Prizes",xtype:"contestprizes",contest:a.record},{title:"Review",xtype:"contestreview",contest:a.record,bodyPadding:20,autoScroll:true}]},{xtype:"contestplayers",region:"east",style:"border-right-width: 0 !important",width:250,margin:"0 0 0 2",contest_id:a.record.get("_id")}]});a.callParent(arguments)}});Ext.define("Bozuko.controller.Contests",{extend:"Bozuko.lib.app.Controller",requires:["Bozuko.lib.app.Controller","Bozuko.view.contest.Reports","Bozuko.view.contest.edit.Form","Bozuko.view.contest.builder.Panel","Bozuko.model.Page"],views:[],stores:[],models:[],refs:[],init:function(){window.pageController=this;var a=this;a.control({contestlist:{itemclick:a.onContestItemClick,render:this.onContestsListRender},"contestreports button[action=back]":{click:a.onContestReportsBackButton},"contestform button[action=save]":{click:this.onContestSaveClick},"contestform button[action=back]":{click:this.onContestBackClick},"contestbuilder button[action=back]":{click:this.onContestBackClick},"contestform panel[region=west] dataview":{itemclick:this.onContestNavClick},"contestspanel button[action=create]":{click:this.onCreateContestClick},"contestspanel button[action=builder]":{click:this.onBuilderButtonClick},"contestspanel contestbuilder":{apply:this.onApplyFromBuilder,save:this.onSaveFromBuilder,publish:this.onPublishFromBuilder}})},onContestsListRender:function(a){var b=this;a.store.on("load",function(c){b.updateCards(c,a)},this)},onContestReportsBackButton:function(b){var a=b.up("contestspanel"),c=a.getLayout().getActiveItem();a.getLayout().setActiveItem(0);a.doComponentLayout();a.remove(c)},onContestBackClick:function(b){var a=b.up("contestspanel"),c=a.getLayout().getActiveItem();a.getLayout().setActiveItem(0);a.doComponentLayout();a.remove(c)},onContestSaveClick:function(c){var k=c.up("contestform"),b=c.up("contestspanel"),i=c.up("pagepanel"),p=b.down("contestlist"),q=i.page,e=k.record,a=k.down("contestformdetails"),d=k.down("contestformprizes"),m=k.down("contestformconsolationprizes"),j=k.down("contestformentry"),o=k.down("contestformrules"),n=k.down("contestformgame");var f=!e.get("_id");c.disable();c.setText(f?"Creating...":"Saving...");e.set("page_id",q.get("_id"));e.set(this.getValues(a));e.set(this.getValues(n));e.set(this.getValues(o));var h=e.get("entry_config");if(h&&h.length){var l=this.getValues(j);h=Ext.Object.merge(h[0],l)}else{h=this.getValues(j)}e.set("entry_config",[h]);var g=e.get("consolation_config");if(g&&g.length){var l=this.getValues(m,"fieldset");g=Ext.Object.merge(g[0],l)}else{g=this.getValues(m,"fieldset")}e.set("consolation_config",[g]);d.updateRecords();m.updateRecords();e.save({success:function(){var r;if(f){e.phantom=false;p.store.add(e);k.down("[ref=edit-label-text]").setText("Edit Campaign:");b.cards[e.get("_id")]=k;e.commit();delete b.cards[""]}k.down("[ref=edit-campaign-text]").setText(e.get("name"));if(b.reports&&(r=i.reports[e.get("_id")])){r.down("[ref=report-campaign-text]").setText(e.get("name"))}d.removeAll();d.updateForms()},callback:function(){i.successStatus("Contest Saved");c.setText("Save");c.enable()}})},onContestNavClick:function(b,a){var c=b.up("contestform");cardPanel=c.down("panel[region=center]"),type=a.get("type"),panel=cardPanel.down("[ref="+type+"]");cardPanel.getLayout().setActiveItem(panel)},onLaunch:function(){},onContestItemClick:function(b,a,g,f,i){var h=i.getTarget();if(h.tagName.toLowerCase()!="a"){return}switch(h.className){case"edit builder":this.openWithBuilder(a,b);break;case"edit":this.editContest(a,b);break;case"delete":Ext.Msg.confirm("Are you sure?","Are you sure you want to delete this campaign?",function(e){if(e!="ok"&&e!="yes"){return}a.store.remove(a);a.destroy({callback:function(){}})});break;case"publish":var d=Bozuko.Router.route("/contests/"+a.getId()+"/publish");Ext.Msg.confirm("Are you sure?","Once the campaign is published, you will not be able to modify it. Are you sure you want to publish this campaign?",function(e){if(e!="ok"&&e!="yes"){return}var j=b.up("contestspanel");j.setLoading("Publishing... This may take a minute, please be patient");Ext.Ajax.request({url:d,timeout:1000*60*5,method:"post",callback:function(m,o,l){j.setLoading(false);if(!o){alert("Publish request was unreadable");return}try{var k=Ext.decode(l.responseText);if(k&&k.success){b.store.load()}}catch(n){}}})});break;case"copy":var c=a.get("name");if(c){c+=" (Copy)"}else{c=Ext.Date.parse(new Date(),"Campaign m-d-Y")}Ext.Msg.prompt({title:"Copy Campaign",msg:"What would you like to name your new campaign?",fn:function(k,m){if(k!=="ok"){return}var n=a.copy();n.phantom=true;var e=n.prizes();var l=n.consolation_prizes();a.prizes().each(function(o){var p=o.copy();p.set("_id","");p.set("won",0);p.set("redeemed",0);e.add(p)});a.consolation_prizes().each(function(o){var p=o.copy();p.set("_id","");p.set("won",0);p.set("redeemed",0);l.add(p)});var j=new Date();diff=n.get("end").getTime()-n.get("start").getTime(),start=j,end=new Date();n.set("_id","");end.setTime(start.getTime()+diff);n.set("start",start);n.set("end",end);n.set("name",m);n.set("active",false);n.set("total_entries",0);n.set("total_plays",0);n.set("play_cursor",-1);n.set("token_cursor",0);n.phantom=true;n.save({callback:function(){b.store.load()}})},icon:Ext.Msg.INFO,prompt:true,width:300,buttons:Ext.Msg.OKCANCEL,value:c,modal:true});break;case"cancel":var d=Bozuko.Router.route("/contests/"+a.getId()+"/cancel");Ext.Msg.confirm("Are you sure?","Are you sure you want to cancel this campaign?",function(e){if(e!="ok"&&e!="yes"){return}Ext.Ajax.request({url:d,method:"post",callback:function(l,n,k){if(!n){return}try{var j=Ext.decode(k.responseText);if(j&&j.success){b.store.load()}}catch(m){}}})});break;case"reports":this.openContest(a,b);break;case"export":this.exportContest(a);break;default:Ext.Msg.show({title:"Not Implemented Yet",msg:"Working on it... Check back soon",buttons:Ext.MessageBox.OK,icon:Ext.Msg.WARNING});break}},onBuilderButtonClick:function(b){var a=b.up("contestspanel");if(!a.builder){a.builder=a.add({border:false,xtype:"contestbuilder",listeners:{destroy:function(){delete a.builder}}})}a.getLayout().setActiveItem(a.builder)},onCreateContestClick:function(b){var a=new Bozuko.model.Contest();this.editContest(a,b)},editContest:function(b,c){var a=c.up("contestspanel"),d=b.get("_id");if(!a.cards){a.cards={}}if(!a.cards[d]){a.cards[d]=a.add({border:false,xtype:"contestform",contest:b,listeners:{destroy:function(){delete a.cards[b.get("_id")]}}});a.cards[d].setRecord(b)}a.getLayout().setActiveItem(a.cards[d]);a.doComponentLayout()},exportContest:function(a){var c=a.getProxy().getWriter().getRecordData(a);var b=Ext.getBody().createChild({tag:"form",action:"/admin/export",method:"post",target:"export",style:"display: none",children:[{tag:"input",type:"hidden",name:"body"}]});try{Ext.Array.each(c.prizes,function(f,e){delete c.prizes[e]._id;delete c.prizes[e].won;delete c.prizes[e].redeemed});Ext.Array.each(c.consolation_prizes,function(f,e){delete c.consolation_prizes[e]._id;delete c.prizes[e].won;delete c.prizes[e].redeemed});delete c._id;delete c.page_id;delete c.play_cursor;delete c.token_cursor;b.down("input").dom.value=Ext.encode(c);b.dom.submit();b.remove()}catch(d){alert("Error during export")}},openWithBuilder:function(b,c){var a=c.up("contestspanel"),d=b.get("_id");if(!a.builders){a.builders={}}if(!a.builders[d]){a.builders[d]=a.add({border:false,xtype:"contestbuilder",contest:b,review:true,listeners:{destroy:function(){delete a.builders[b.get("_id")]}}})}a.getLayout().setActiveItem(a.builders[d]);a.doComponentLayout()},onApplyFromBuilder:function(a,b){this.onSaveFromBuilder(a,b,true)},onSaveFromBuilder:function(e,h,g){var a=e.up("contestspanel"),c=a.getLayout().getActiveItem(),f=a.up("pagepanel"),b=e.down("contestbuildercard{isVisible()} button[ref="+(g?"apply":"save")+"]"),i=a.down("contestlist"),d=!!e.contest.get("_id");e.contest.set("page_id",f.page.get("_id"));b.disable();b.setText("Saving...");setTimeout(function(){e.contest.save({success:function(){if(!g){a.getLayout().setActiveItem(0);i.store.load();a.remove(c)}},callback:function(){f.successStatus("Contest Saved");try{b.setText(g?"Save":"Save and Close");b.enable()}catch(j){}}})},100)},onPublishFromBuilder:function(c){var b=c.up("contestspanel"),e=b.getLayout().getActiveItem(),f=b.up("pagepanel"),d=c.down("button[ref=save]"),g=b.down("contestlist"),a=!!c.contest.get("_id");c.contest.set("page_id",f.page.get("_id"));Ext.Msg.confirm("Are you sure?","Are you sure you want to publish this campaign?",function(h){if(h!="ok"&&h!="yes"){return}d.disable();d.setText("Saving...");c.contest.save({success:function(){b.getLayout().setActiveItem(0);b.remove(e);var i=Bozuko.Router.route("/contests/"+c.contest.getId()+"/publish");b.setLoading("Publishing... This may take a minute, please be patient");Ext.Ajax.request({url:i,timeout:1000*60*5,method:"post",callback:function(l,n,k){b.setLoading(false);if(!n){alert("Publish request was unreadable");return}try{var j=Ext.decode(k.responseText);if(j&&j.success){}}catch(m){}b.down("contestlist").store.load()}})},callback:function(){f.successStatus("Contest Saved")}})})},openContest:function(b,c){var a=c.up("contestspanel"),d=b.get("_id");if(!a.reports){a.reports={}}if(!a.reports[d]){a.reports[d]=a.add({border:false,record:b,xtype:"contestreports",listeners:{destroy:function(){delete a.reports[d]}}})}a.getLayout().setActiveItem(a.reports[d]);a.doComponentLayout()},getValues:function(c,a){var b={};a=a?a+" field":"field";Ext.Array.each(c.query(a),function(g){var d=g.getName();var e=d.split("."),h=b;if(e.length>1){while(e.length>1){var f=e.shift();if(!h[f]){h[f]={}}h=h[f]}}h[e.shift()]=g.getValue()});return b},updateCards:function(c,b){var a=b.up("contestspanel");if(a.cards){Ext.Object.each(a.cards,function(f,e){var d;if(!(d=c.getById(f))){a.remove(e)}else{e.setRecord(d)}})}if(a.reports){Ext.Object.each(a.reports,function(f,e){var d;if(!(d=c.getById(f))){a.remove(e)}else{e.setRecord(d)}})}}});
